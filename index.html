<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Horario ESFM">
    <meta name="theme-color" content="#006847">
    <meta name="google-site-verification" content="QVKYJpmBb5H8l-qwNZcoj81UTPMNUup9NqB9lhX2hM8" />
    <!-- Version: 2.1 - Fix auth screen cache issue -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="description" content="Aplicaci√≥n de horario escolar con recordatorios y calendario para E.S.F.M. Sim√≥n Bol√≠var">
    
    <!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>

<!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons for iOS -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%23006847'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='256' fill='white'>üìÖ</text></svg>">
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Google Fonts - Inter for modern, clean typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google APIs para integraci√≥n con Google Calendar -->
    <!-- Estas constantes y stubs deben definirse ANTES de que los scripts async carguen -->
    <script>
        var CALENDAR_CLIENT_ID = '1046696947499-jsdv5lobhj5vc9af7vv02b6qsh3n83sv.apps.googleusercontent.com';
        var CALENDAR_API_KEY = 'AIzaSyBDKybOzpS2oQWziONmgzeSks8sDdGBe1k';
        var CALENDAR_SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        var gapiInited = false;
        var gisInited = false;
        var tokenClient;

        function gapiLoaded() {
            gapi.load('client', function() {
                gapi.client.init({
                    apiKey: CALENDAR_API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
                }).then(function() {
                    gapiInited = true;
                    console.log('‚úÖ Google Calendar API (GAPI) lista');
                }).catch(function(err) {
                    console.warn('‚ö†Ô∏è Error al inicializar GAPI:', err);
                });
            });
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CALENDAR_CLIENT_ID,
                    scope: CALENDAR_SCOPES,
                    callback: '',
                });
                gisInited = true;
                console.log('‚úÖ Google Identity Services (GIS) listo');
            } catch(err) {
                console.warn('‚ö†Ô∏è Error al inicializar GIS:', err);
            }
        }

        function initGoogleCalendar() {
            if (typeof gapi !== 'undefined' && !gapiInited) gapiLoaded();
            if (typeof google !== 'undefined' && !gisInited) gisLoaded();
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    
    <title>Horario ESFM Sim√≥n Bol√≠var</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        button, input, select, textarea {
            font-family: inherit;
        }

        :root {
            --primary: #006847;
            --secondary: #FFD700;
            --red: #CE1126;
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #333;
            --border: #ddd;
        }

        body.dark-mode {
            --primary: #00A86B;
            --secondary: #FFD700;
            --red: #FF6B6B;
            --bg: #121212;
            --card: #1E1E1E;
            --text: #E0E0E0;
            --border: #333;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            padding-bottom: 70px;
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.01em;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), #008855);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 18px;
            margin-bottom: 5px;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .header .subtitle {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 500;
            letter-spacing: 0.03em;
        }

        /* Date Navigation */
        .date-nav {
            background: white;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .date-nav button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        .current-date {
            font-weight: 700;
            font-size: 16px;
            letter-spacing: -0.01em;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .tab {
            flex: 1;
            padding: 10px 5px;
            text-align: center;
            border: none;
            background: white;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 13px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .tab-day {
            font-weight: 700;
            font-size: 14px;
        }

        .tab-date {
            font-size: 11px;
            opacity: 0.7;
            font-weight: 500;
        }

        .tab.holiday {
            background: linear-gradient(to bottom, #FFF3E0, #FFE0B2);
            color: #E65100;
        }

        .tab.holiday .tab-day::after {
            content: ' üéâ';
            font-size: 10px;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .tab.active.holiday {
            border-bottom-color: #FF9800;
        }

        /* Content */
        .content {
            padding: 15px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .schedule-card {
            background: var(--card);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .schedule-card.merged-start {
            border-radius: 10px 10px 0 0;
            margin-bottom: 0;
            padding-bottom: 8px;
        }

        .schedule-card.merged-middle {
            border-radius: 0;
            margin-bottom: 0;
            margin-top: 0;
            padding-top: 8px;
            padding-bottom: 8px;
            border-top: 2px dashed rgba(0, 104, 71, 0.2);
        }

        .schedule-card.merged-end {
            border-radius: 0 0 10px 10px;
            margin-top: 0;
            padding-top: 8px;
            margin-bottom: 15px;
            border-top: 2px dashed rgba(0, 104, 71, 0.2);
        }

        .schedule-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .schedule-card.merged-start:hover,
        .schedule-card.merged-middle:hover,
        .schedule-card.merged-end:hover {
            transform: none;
        }

        .edit-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            color: #666;
            font-weight: 500;
        }

        .edit-btn:hover {
            background: white;
            color: var(--primary);
        }

        .schedule-card.break {
            background: #FFF9E6;
            border-left-color: var(--secondary);
            text-align: center;
            cursor: default;
            padding: 10px 15px;
        }

        .schedule-card.break:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Current Period Highlighting */
        .schedule-card.current-period {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9) !important;
            border-left: 5px solid #4CAF50 !important;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4) !important;
            animation: pulse-glow 2s ease-in-out infinite;
            position: relative;
        }

        @keyframes pulse-glow {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
            }
        }

        .current-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 700;
            animation: badge-blink 1.5s ease-in-out infinite;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
        }

        @keyframes badge-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.75; }
        }

        /* Past Period Styling */
        .schedule-card.past-period {
            opacity: 0.6;
            background: #f5f5f5 !important;
            border-left-color: #9E9E9E !important;
        }

        .schedule-card.past-period .subject,
        .schedule-card.past-period .teacher,
        .schedule-card.past-period .time {
            text-decoration: line-through;
            color: #999;
        }

        .past-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #9E9E9E;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 700;
        }

        .schedule-card .period {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 3px;
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        .schedule-card .time {
            font-size: 13px;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: 0.01em;
        }

        .schedule-card .subject {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.35;
            letter-spacing: -0.01em;
        }

        .schedule-card .teacher {
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .schedule-card .actions {
            display: flex;
            gap: 10px;
        }

        .schedule-card button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            font-weight: 500;
        }

        .btn-note {
            background: #E3F2FD;
            color: #1565C0;
            font-weight: 500;
        }

        .btn-note:hover {
            background: #BBDEFB;
        }

        .btn-reminder {
            background: #FFF9C4;
            color: #F57F17;
            font-weight: 500;
        }

        .btn-reminder:hover {
            background: #FFF59D;
        }

        .settings-btn {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 50%;
            font-size: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.2s;
        }

        .settings-btn:active {
            transform: scale(0.95);
        }

        /* Calendar Grid */
        .calendar {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .weekday {
            text-align: center;
            font-weight: 700;
            font-size: 12px;
            padding: 10px 0;
            color: var(--primary);
            letter-spacing: 0.03em;
            text-transform: uppercase;
        }

        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .day:hover {
            background: #f0f0f0;
        }

        .day.today {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .day.selected {
            background: var(--secondary);
            font-weight: 600;
        }

        .day.has-event::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 5px;
            height: 5px;
            background: var(--red);
            border-radius: 50%;
        }

        .day.holiday {
            background: linear-gradient(135deg, #FF9800, #FFA726);
            color: white;
            font-weight: 700;
        }

        .day.holiday::before {
            content: 'üéâ';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
        }

        /* Reminders List */
        .reminder-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid var(--red);
            position: relative;
            transition: all 0.3s;
        }

        .reminder-item.completed {
            opacity: 0.6;
            background: #f5f5f5;
        }

        .reminder-item.completed .title {
            text-decoration: line-through;
            color: #999;
        }

        .reminder-item.tarea {
            border-left-color: #4CAF50;
        }

        .reminder-item.examen {
            border-left-color: #f44336;
        }

        .reminder-item.exposicion {
            border-left-color: #2196F3;
        }

        .reminder-item.evento {
            border-left-color: #9C27B0;
        }

        .reminder-item.congreso {
            border-left-color: #FF9800;
        }

        .reminder-item .title {
            font-weight: 700;
            margin-bottom: 5px;
            letter-spacing: -0.01em;
        }

        .reminder-item .type {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 11px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .reminder-item .type.tarea {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .reminder-item .type.examen {
            background: #FFEBEE;
            color: #C62828;
        }

        .reminder-item .type.exposicion {
            background: #E3F2FD;
            color: #1565C0;
        }

        .reminder-item .type.evento {
            background: #F3E5F5;
            color: #6A1B9A;
        }

        .reminder-item .type.congreso {
            background: #FFF3E0;
            color: #E65100;
        }

        .reminder-item .type.otro {
            background: #ECEFF1;
            color: #455A64;
        }

        .reminder-item .date {
            font-size: 12px;
            color: #666;
        }

        .checkbox-complete {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .reminder-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .reminder-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-complete {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .btn-delete {
            background: #FFEBEE;
            color: #C62828;
        }

        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* FAB Button */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 28px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s;
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            background: none;
            cursor: pointer;
            color: #666;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item .icon {
            font-size: 24px;
            margin-bottom: 3px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            letter-spacing: -0.02em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-cancel {
            background: #f0f0f0;
        }

        .btn-save {
            background: var(--primary);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="auth-screen" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, var(--primary), #008855); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 40px 30px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 60px; margin-bottom: 10px;">üìÖ</div>
                <h2 style="font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 5px;">Horario ESFM</h2>
                <p style="color: #666; font-size: 14px;">Sim√≥n Bol√≠var</p>
            </div>

            <!-- Login/Register Tabs -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0;">
                <button id="tab-login" onclick="switchAuthTab('login')" style="flex: 1; padding: 12px; border: none; background: none; font-weight: 600; color: var(--primary); border-bottom: 3px solid var(--primary); cursor: pointer;">
                    Iniciar Sesi√≥n
                </button>
                <button id="tab-register" onclick="switchAuthTab('register')" style="flex: 1; padding: 12px; border: none; background: none; font-weight: 600; color: #999; cursor: pointer;">
                    Registrarse
                </button>
            </div>

            <!-- Login Form -->
            <div id="login-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; color: #333;">Correo electr√≥nico</label>
                    <input type="email" id="login-email" placeholder="tu@email.com" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; color: #333;">Contrase√±a</label>
                    <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>
                <button type="button" onclick="loginWithEmail()" style="width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 16px; cursor: pointer; margin-bottom: 15px;">
                    Entrar
                </button>
            </div>

            <!-- Register Form -->
            <div id="register-form" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; color: #333;">Nombre completo</label>
                    <input type="text" id="register-name" placeholder="Tu nombre" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; color: #333;">Correo electr√≥nico</label>
                    <input type="email" id="register-email" placeholder="tu@email.com" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; color: #333;">Contrase√±a</label>
                    <input type="password" id="register-password" placeholder="M√≠nimo 6 caracteres" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; color: #333;">Confirmar contrase√±a</label>
                    <input type="password" id="register-password-confirm" placeholder="Repite tu contrase√±a" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>
                <button type="button" onclick="registerWithEmail()" style="width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 16px; cursor: pointer; margin-bottom: 15px;">
                    Crear Cuenta
                </button>
            </div>

            <!-- Divider -->
            <div style="text-align: center; margin: 20px 0; color: #999; position: relative;">
                <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: #e0e0e0;"></div>
                <span style="background: white; padding: 0 15px; position: relative; font-size: 14px;">o continuar con</span>
            </div>

            <!-- Google Sign In -->
            <button type="button" onclick="loginWithGoogle()" style="width: 100%; padding: 14px; background: white; color: #333; border: 2px solid #e0e0e0; border-radius: 8px; font-weight: 600; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
                Google
            </button>

            <p id="auth-error" style="margin-top: 15px; color: #f44336; font-size: 14px; text-align: center; display: none;"></p>
            <div id="auth-loading" style="margin-top: 15px; text-align: center; display: none;">
                <div style="display: inline-block; width: 30px; height: 30px; border: 3px solid var(--primary); border-radius: 50%; border-top-color: transparent; animation: spin 0.8s linear infinite;"></div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="main-app" style="display: none;">
    <!-- Header -->
    <div class="header">
        <h1>E.S.F.M. "SIM√ìN BOL√çVAR"</h1>
        <div class="subtitle">1RO MATEM√ÅTICA</div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-item active" data-view="horario">
            <div class="icon">üìÖ</div>
            <div>Horario</div>
        </button>
        <button class="nav-item" data-view="calendario">
            <div class="icon">üìÜ</div>
            <div>Calendario</div>
        </button>
        <button class="nav-item" data-view="recordatorios">
            <div class="icon">üîî</div>
            <div>Recordatorios</div>
        </button>
        <button class="nav-item" data-view="asistencia">
            <div class="icon">‚úÖ</div>
            <div>Asistencia</div>
        </button>
        <button class="nav-item" data-view="config">
            <div class="icon">‚öôÔ∏è</div>
            <div>Config</div>
        </button>
    </div>

    <!-- Content Container -->
    <div class="content-container">
        <!-- Horario View -->
        <div class="tab-content active" id="horario-view">
            <div class="date-nav">
                <button onclick="changeWeek(-1)">‚óÑ</button>
                <div class="current-date" id="current-week"></div>
                <button onclick="changeWeek(1)">‚ñ∫</button>
            </div>
            
            <div class="tabs" id="day-tabs">
                <!-- Tabs will be generated dynamically with dates -->
            </div>

            <div class="content" id="schedule-content"></div>
        </div>

        <!-- Calendario View -->
        <div class="tab-content" id="calendario-view">
            <div class="content">
                <div class="calendar">
                    <div class="date-nav" style="margin-bottom: 15px;">
                        <button onclick="changeMonth(-1)">‚óÑ</button>
                        <div class="current-date" id="current-month"></div>
                        <button onclick="changeMonth(1)">‚ñ∫</button>
                    </div>
                    <div class="weekdays">
                        <div class="weekday">Dom</div>
                        <div class="weekday">Lun</div>
                        <div class="weekday">Mar</div>
                        <div class="weekday">Mi√©</div>
                        <div class="weekday">Jue</div>
                        <div class="weekday">Vie</div>
                        <div class="weekday">S√°b</div>
                    </div>
                    <div class="days" id="calendar-days"></div>
                </div>
                <div id="day-events" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Recordatorios View -->
        <div class="tab-content" id="recordatorios-view">
            <div style="background: white; padding: 10px 15px; display: flex; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px;">
                <button class="filter-btn active" data-filter="all" onclick="filterReminders('all')" style="flex: 1; padding: 8px; border: none; border-radius: 5px; background: var(--primary); color: white; font-size: 13px; cursor: pointer; font-weight: 500;">
                    üìã Todos
                </button>
                <button class="filter-btn" data-filter="pending" onclick="filterReminders('pending')" style="flex: 1; padding: 8px; border: none; border-radius: 5px; background: #f0f0f0; color: #666; font-size: 13px; cursor: pointer; font-weight: 500;">
                    ‚è≥ Pendientes
                </button>
                <button class="filter-btn" data-filter="completed" onclick="filterReminders('completed')" style="flex: 1; padding: 8px; border: none; border-radius: 5px; background: #f0f0f0; color: #666; font-size: 13px; cursor: pointer; font-weight: 500;">
                    ‚úÖ Completados
                </button>
            </div>
            <div class="content" id="reminders-content"></div>
        </div>

        <!-- Asistencia View -->
        <div class="tab-content" id="asistencia-view">
            <div style="background: white; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="font-size: 16px; font-weight: 600;">Control de Asistencia</h3>
                    <button onclick="openAttendanceSettings()" style="padding: 8px 15px; background: #E3F2FD; border: none; border-radius: 5px; color: #1565C0; font-size: 12px; cursor: pointer; font-weight: 500;">
                        ‚öôÔ∏è Estudiantes
                    </button>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="date" id="attendance-date-picker" onchange="updateAttendanceDate()" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <select id="attendance-subject-picker" onchange="updateAttendanceSubject()" style="flex: 2; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    </select>
                </div>

                <!-- Quick Action Buttons -->
                <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                    <button onclick="markAllPresent()" style="flex: 1; padding: 10px; background: #E8F5E9; border: none; border-radius: 5px; color: #2E7D32; font-size: 12px; cursor: pointer; font-weight: 600;">
                        ‚úÖ Todos Presentes
                    </button>
                    <button onclick="clearAllAttendance()" style="flex: 1; padding: 10px; background: #FFF3E0; border: none; border-radius: 5px; color: #E65100; font-size: 12px; cursor: pointer; font-weight: 600;">
                        üîÑ Limpiar Todo
                    </button>
                </div>

                <!-- Statistics Cards -->
                <div id="attendance-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;"></div>
            </div>

            <!-- Student Roster -->
            <div class="content" id="attendance-roster"></div>

            <!-- History Button -->
            <div style="padding: 0 15px 15px;">
                <button onclick="openGradesView()" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 10px;">
                    üìù Calificaciones y Evaluaci√≥n
                </button>
                <button onclick="openAttendanceHistory()" style="width: 100%; padding: 12px; background: white; border: 2px solid var(--primary); color: var(--primary); border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 10px;">
                    üìä Ver Historial de Asistencia
                </button>
                <button onclick="exportToExcel()" style="width: 100%; padding: 12px; background: #E8F5E9; color: #2E7D32; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 10px;">
                    üì• Exportar a Excel
                </button>
                <div style="background: #FFF3E0; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #E65100;">üíæ Respaldo de Datos</div>
                    <button onclick="exportBackup()" style="width: 100%; padding: 10px; background: #2196F3; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 8px;">
                        üíæ Crear Backup
                    </button>
                    <button onclick="openImportBackup()" style="width: 100%; padding: 10px; background: #FF9800; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        üìÇ Restaurar Backup
                    </button>
                </div>
            </div>
        </div>

    <!-- Config View -->
    <div class="tab-content" id="config-view">
        <div class="content">
            <!-- Academic Calendar Config -->
            <div class="card">
                <h2 style="margin-bottom: 15px;">üìÖ Configuraci√≥n Acad√©mica</h2>
                
                <div class="form-group">
                    <label>Fecha de Inicio de Clases</label>
                    <input type="date" id="academic-start-date" value="2026-02-09">
                </div>
                
                <div class="form-group">
                    <label>Fecha de Fin de Clases</label>
                    <input type="date" id="academic-end-date" value="2026-11-30">
                </div>
                
                <div class="form-group">
                    <label>Inicio Vacaciones de Medio A√±o</label>
                    <input type="date" id="midyear-start" value="2026-07-01">
                </div>
                
                <div class="form-group">
                    <label>Fin Vacaciones de Medio A√±o</label>
                    <input type="date" id="midyear-end" value="2026-07-31">
                </div>
                
                <button onclick="saveAcademicConfig()" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    üíæ Guardar Configuraci√≥n
                </button>
            </div>

            <!-- Holidays Management -->
            <div class="card">
                <h2 style="margin-bottom: 15px;">üéâ Gesti√≥n de Feriados</h2>
                <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                    üí° Tambi√©n puedes tocar cualquier fecha en el Calendario para marcarla como feriado
                </p>
                
                <div id="holidays-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
                
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                    <h3 style="font-size: 14px; margin-bottom: 10px;">‚ûï Agregar Feriado</h3>
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="new-holiday-date">
                    </div>
                    <div class="form-group">
                        <label>Nombre del Feriado</label>
                        <input type="text" id="new-holiday-name" placeholder="Ej: D√≠a de la Independencia">
                    </div>
                    <button onclick="addHoliday()" style="width: 100%; padding: 10px; background: #FF9800; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        ‚ûï Agregar Feriado
                    </button>
                </div>
            </div>

            <!-- Schedule Settings Link -->
            <div class="card">
                <h2 style="margin-bottom: 15px;">‚öôÔ∏è Configuraci√≥n del Horario</h2>
                <button onclick="openSettings()" style="width: 100%; padding: 12px; background: #2196F3; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    üìù Editar Horario, Materias y Docentes
                </button>
            </div>

            <!-- Backup Section -->
            <div style="background: #FFF3E0; padding: 15px; border-radius: 10px; margin-top: 15px;">
                <h3 style="margin-bottom: 10px; color: #E65100;">üíæ Respaldo de Datos</h3>
                <button onclick="exportBackup()" style="width: 100%; padding: 10px; background: #2196F3; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 8px;">
                    üíæ Crear Backup
                </button>
                <button onclick="openImportBackup()" style="width: 100%; padding: 10px; background: #FF9800; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    üìÇ Restaurar Backup
                </button>
            </div>

            <!-- Notification Settings -->
            <div style="background: #E8F5E9; padding: 15px; border-radius: 10px; margin-top: 15px;">
                <h3 style="margin-bottom: 15px; color: #2E7D32;">üîî Configuraci√≥n de Notificaciones</h3>

                <div id="notification-status" style="font-size: 13px; margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px;"></div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">M√©todo de Notificaciones:</label>
                    <select id="notification-method" onchange="saveNotificationMethod()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 10px;">
                        <option value="web">üîî Notificaciones Web (En la app)</option>
                        <option value="calendar">üìÖ Google Calendar (Recomendado)</option>
                        <option value="both">üîîüìÖ Ambos m√©todos</option>
                    </select>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px; line-height: 1.4;">
                        ‚ÑπÔ∏è <b>Google Calendar:</b> Sincroniza con tu calendario y usa las notificaciones nativas de tu dispositivo.<br>
                        <b>Web:</b> Notificaciones dentro de la app.
                    </p>
                </div>

                <button onclick="enableNotifications()" style="width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 8px;">
                    üîî Habilitar Notificaciones
                </button>

                <button onclick="testNotification()" style="width: 100%; padding: 10px; background: white; border: 2px solid #4CAF50; color: #4CAF50; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    üß™ Probar Notificaci√≥n
                </button>
            </div>

            <!-- Dark Mode Settings -->
            <div style="background: #E8EAF6; padding: 15px; border-radius: 10px; margin-top: 15px;">
                <h3 style="margin-bottom: 10px; color: #3F51B5;">üåô Modo de Visualizaci√≥n</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="setTheme('light')" id="theme-light-btn" style="flex: 1; padding: 12px; background: white; border: 2px solid #ddd; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        ‚òÄÔ∏è D√≠a
                    </button>
                    <button onclick="setTheme('dark')" id="theme-dark-btn" style="flex: 1; padding: 12px; background: #263238; color: white; border: 2px solid #263238; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        üåô Noche
                    </button>
                </div>
                <p style="font-size: 11px; color: #666; margin-top: 8px; line-height: 1.4;">
                    üí° Elige el modo que sea m√°s c√≥modo para tus ojos
                </p>
            </div>

            <!-- User Account Section -->
            <div style="background: #FFEBEE; padding: 15px; border-radius: 10px; margin-top: 15px;">
                <h3 style="margin-bottom: 10px; color: #C62828;">üë§ Cuenta de Usuario</h3>
                <div id="user-info" style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 14px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">Email:</div>
                    <div id="user-email" style="color: #666;">Cargando...</div>
                </div>
                <button onclick="logout()" style="width: 100%; padding: 12px; background: #F44336; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    üö™ Cerrar Sesi√≥n
                </button>
                <p style="font-size: 11px; color: #666; margin-top: 8px; line-height: 1.4;">
                    üí° Tus datos est√°n sincronizados en la nube. Puedes volver a iniciar sesi√≥n en cualquier dispositivo.
                </p>
            </div>

            <!-- Privacy Policy Link -->
            <div style="text-align: center; padding: 20px 0 10px;">
                <a href="/privacy-policy.html" target="_blank" rel="noopener"
                   style="font-size: 13px; color: #666; text-decoration: underline;">
                    Pol√≠tica de Privacidad
                </a>
                <span style="color: #ccc; margin: 0 8px;">|</span>
                <a href="/terms.html" target="_blank" rel="noopener"
                   style="font-size: 13px; color: #666; text-decoration: underline;">
                    Condiciones de Servicio
                </a>
                <span style="color: #ccc; margin: 0 8px;">|</span>
                <span style="font-size: 13px; color: #999;">Horario ESFM &copy; 2026</span>
            </div>
        </div>
    </div>
    </div>

    <!-- Legal Footer - always visible for Google verification -->
    <footer id="legal-footer" style="position:fixed;bottom:60px;left:0;right:0;text-align:center;z-index:999;background:rgba(0,104,71,0.92);padding:5px 0;">
        <a href="/privacy-policy.html" style="color:#fff;font-size:12px;text-decoration:underline;margin:0 10px;">Pol√≠tica de Privacidad</a>
        <span style="color:#fff;font-size:12px;">|</span>
        <a href="/terms.html" style="color:#fff;font-size:12px;text-decoration:underline;margin:0 10px;">T√©rminos de Servicio</a>
    </footer>

    <!-- FAB Button -->
    <button class="fab" onclick="openModal()">+</button>

    <!-- Modal for Adding Reminder -->
    <div class="modal" id="reminder-modal">
        <div class="modal-content">
            <div class="modal-header">
                Agregar Recordatorio
                <button onclick="openCategoryManager()" style="float: right; background: #E3F2FD; color: #1565C0; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; cursor: pointer; font-weight: 500;">
                    üè∑Ô∏è Gestionar Categor√≠as
                </button>
            </div>
            <div class="form-group">
                <label>Tipo</label>
                <select id="reminder-type"></select>
            </div>
            <div class="form-group">
                <label>Materia</label>
                <select id="reminder-subject">
                    <option value="">Seleccionar materia (opcional)</option>
                </select>
            </div>
            <div class="form-group">
                <label>T√≠tulo</label>
                <input type="text" id="reminder-title" placeholder="Ej: Resolver ejercicios p√°gina 45">
            </div>
            <div class="form-group">
                <label>Descripci√≥n (opcional)</label>
                <textarea id="reminder-description" placeholder="Agregar detalles..."></textarea>
            </div>
            <div class="form-group">
                <label>Fecha</label>
                <input type="date" id="reminder-date">
            </div>
            <div class="form-group">
                <label>Hora (opcional)</label>
                <input type="time" id="reminder-time">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
                <button class="btn-save" onclick="saveReminder()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal for Class Details -->
    <div class="modal" id="class-modal">
        <div class="modal-content">
            <div class="modal-header" id="class-modal-title"></div>
            <div id="class-modal-content"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-save" onclick="addReminderFromClass()" style="flex: 1;">‚è∞ Agregar Recordatorio</button>
                <button class="btn-cancel" onclick="closeClassModal()" style="flex: 1;">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal for Settings -->
    <div class="modal" id="settings-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">‚öôÔ∏è Configuraci√≥n del Horario</div>
            
            <!-- Tabs for Settings -->
            <div style="display: flex; gap: 5px; margin-bottom: 20px; background: #f5f5f5; padding: 5px; border-radius: 8px; overflow-x: auto;">
                <button class="settings-tab active" data-tab="schedule" onclick="switchSettingsTab('schedule')" style="flex: 1; min-width: 80px; padding: 10px; border: none; border-radius: 5px; background: white; font-size: 12px; cursor: pointer; font-weight: 500; white-space: nowrap;">
                    üìÖ Horario
                </button>
                <button class="settings-tab" data-tab="subjects" onclick="switchSettingsTab('subjects')" style="flex: 1; min-width: 80px; padding: 10px; border: none; border-radius: 5px; background: transparent; font-size: 12px; cursor: pointer; font-weight: 500; color: #666; white-space: nowrap;">
                    üìö Materias
                </button>
                <button class="settings-tab" data-tab="teachers" onclick="switchSettingsTab('teachers')" style="flex: 1; min-width: 80px; padding: 10px; border: none; border-radius: 5px; background: transparent; font-size: 12px; cursor: pointer; font-weight: 500; color: #666; white-space: nowrap;">
                    üë®‚Äçüè´ Docentes
                </button>
                <button class="settings-tab" data-tab="periods" onclick="switchSettingsTab('periods')" style="flex: 1; min-width: 80px; padding: 10px; border: none; border-radius: 5px; background: transparent; font-size: 12px; cursor: pointer; font-weight: 500; color: #666; white-space: nowrap;">
                    üïê Per√≠odos
                </button>
                <button class="settings-tab" data-tab="times" onclick="switchSettingsTab('times')" style="flex: 1; min-width: 80px; padding: 10px; border: none; border-radius: 5px; background: transparent; font-size: 12px; cursor: pointer; font-weight: 500; color: #666; white-space: nowrap;">
                    ‚è∞ Horarios
                </button>
            </div>

            <!-- Schedule Tab -->
            <div id="settings-schedule-tab" class="settings-tab-content">
                <div style="margin-bottom: 20px;">
                    <p style="color: #666; font-size: 14px;">Administra tu horario escolar. Puedes editar, agregar o eliminar clases para cada d√≠a.</p>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Seleccionar d√≠a:</label>
                    <select id="settings-day-select" onchange="loadDayForEditing()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        <option value="lunes">Lunes</option>
                        <option value="martes">Martes</option>
                        <option value="miercoles">Mi√©rcoles</option>
                        <option value="jueves">Jueves</option>
                        <option value="viernes">Viernes</option>
                    </select>
                </div>

                <div id="settings-classes-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;"></div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="addNewClass()" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        ‚ûï Agregar Nueva Clase
                    </button>
                    <button onclick="resetSchedule()" style="padding: 12px 20px; background: #FFEBEE; color: #C62828; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        üîÑ Restaurar
                    </button>
                </div>
            </div>

            <!-- Subjects Tab -->
            <div id="settings-subjects-tab" class="settings-tab-content" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Gestiona tu cat√°logo de materias. Estas materias aparecer√°n como opciones al editar tu horario.</p>
                    
                    <div id="subjects-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>

                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; font-size: 14px;">‚ûï Agregar Nueva Materia</h4>
                        <div class="form-group">
                            <input type="text" id="new-subject-name" placeholder="Nombre completo de la materia" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <button onclick="addSubject()" style="width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer;">
                            Agregar Materia
                        </button>
                    </div>
                </div>
            </div>

            <!-- Teachers Tab -->
            <div id="settings-teachers-tab" class="settings-tab-content" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Gestiona tu cat√°logo de docentes. Estos docentes aparecer√°n como opciones al editar tu horario.</p>
                    
                    <div id="teachers-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>

                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; font-size: 14px;">‚ûï Agregar Nuevo Docente</h4>
                        <div class="form-group">
                            <input type="text" id="new-teacher-name" placeholder="Nombre completo del docente" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <button onclick="addTeacher()" style="width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer;">
                            Agregar Docente
                        </button>
                    </div>
                </div>
            </div>

            <!-- Periods Tab -->
            <div id="settings-periods-tab" class="settings-tab-content" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Gestiona tus per√≠odos de clase (1er periodo, 2do periodo, etc.).</p>
                    
                    <div id="periods-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>

                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; font-size: 14px;">‚ûï Agregar Nuevo Per√≠odo</h4>
                        <div class="form-group">
                            <input type="text" id="new-period-name" placeholder="Ej: 7mo periodo" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <button onclick="addPeriod()" style="width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer;">
                            Agregar Per√≠odo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Time Slots Tab -->
            <div id="settings-times-tab" class="settings-tab-content" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Gestiona tus horarios (franjas horarias como 8:00 - 9:00).</p>
                    
                    <div id="times-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>

                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; font-size: 14px;">‚ûï Agregar Nueva Franja Horaria</h4>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <input type="time" id="new-time-start" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <span style="font-weight: 600;">-</span>
                            <input type="time" id="new-time-end" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <button onclick="addTimeSlot()" style="width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer;">
                            Agregar Horario
                        </button>
                    </div>
                </div>
            </div>

            <button onclick="closeSettings()" style="width: 100%; padding: 12px; background: #f0f0f0; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px;">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal for Editing Class -->
    <div class="modal" id="edit-class-modal">
        <div class="modal-content">
            <div class="modal-header">‚úèÔ∏è Editar Clase</div>
            
            <div class="form-group">
                <label>D√≠a de la semana</label>
                <select id="edit-day" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <option value="lunes">Lunes</option>
                    <option value="martes">Martes</option>
                    <option value="miercoles">Mi√©rcoles</option>
                    <option value="jueves">Jueves</option>
                    <option value="viernes">Viernes</option>
                </select>
            </div>

            <div class="form-group">
                <label>Per√≠odo</label>
                <select id="edit-period" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                </select>
                <button onclick="openQuickAddPeriod()" style="margin-top: 5px; padding: 6px 12px; background: #E3F2FD; border: none; border-radius: 5px; color: #1565C0; font-size: 12px; cursor: pointer; font-weight: 500;">
                    ‚ûï Agregar nuevo per√≠odo
                </button>
            </div>

            <div class="form-group">
                <label>Horario</label>
                <select id="edit-time-slot" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                </select>
                <button onclick="openQuickAddTimeSlot()" style="margin-top: 5px; padding: 6px 12px; background: #E3F2FD; border: none; border-radius: 5px; color: #1565C0; font-size: 12px; cursor: pointer; font-weight: 500;">
                    ‚ûï Agregar nuevo horario
                </button>
            </div>

            <div class="form-group">
                <label>Materia</label>
                <select id="edit-subject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                </select>
                <button onclick="openQuickAddSubject()" style="margin-top: 5px; padding: 6px 12px; background: #E3F2FD; border: none; border-radius: 5px; color: #1565C0; font-size: 12px; cursor: pointer; font-weight: 500;">
                    ‚ûï Agregar nueva materia
                </button>
            </div>

            <div class="form-group">
                <label>Docente</label>
                <select id="edit-teacher" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                </select>
                <button onclick="openQuickAddTeacher()" style="margin-top: 5px; padding: 6px 12px; background: #E3F2FD; border: none; border-radius: 5px; color: #1565C0; font-size: 12px; cursor: pointer; font-weight: 500;">
                    ‚ûï Agregar nuevo docente
                </button>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="edit-is-break" onchange="toggleBreakFields()">
                    <span>Es un recreo/descanso</span>
                </label>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeEditClass()">Cancelar</button>
                <button class="btn-save" onclick="saveEditedClass()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal for Category Management -->
    <div class="modal" id="category-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">üè∑Ô∏è Gestionar Categor√≠as</div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Personaliza las categor√≠as de tus recordatorios</p>
                <div id="categories-list"></div>
            </div>

            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 10px; font-size: 14px;">‚ûï Agregar Nueva Categor√≠a</h4>
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="new-category-name" placeholder="Ej: Seminario">
                </div>
                <div class="form-group">
                    <label>Emoji/√çcono</label>
                    <input type="text" id="new-category-icon" placeholder="Ej: üéØ" maxlength="2">
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="color" id="new-category-color" value="#2196F3">
                </div>
                <button onclick="addNewCategory()" style="width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer;">
                    Agregar Categor√≠a
                </button>
            </div>

            <button onclick="closeCategoryManager()" style="width: 100%; padding: 12px; background: #f0f0f0; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal for Attendance Settings -->
    <div class="modal" id="attendance-settings-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">‚öôÔ∏è Lista de Estudiantes</div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Gestiona la lista de estudiantes de tu clase.</p>
                
                <div id="students-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>

                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px; font-size: 14px;">‚ûï Agregar Estudiante</h4>
                    <div class="form-group">
                        <input type="text" id="new-student-name" placeholder="Nombre completo del estudiante" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <button onclick="addStudent()" style="width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer;">
                        Agregar Estudiante
                    </button>
                </div>
            </div>

            <button onclick="closeAttendanceSettings()" style="width: 100%; padding: 12px; background: #f0f0f0; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal for Attendance History -->
    <div class="modal" id="attendance-history-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">üìä Historial de Asistencia</div>
            
            <div style="margin-bottom: 15px;">
                <select id="history-subject-filter" onchange="filterHistory()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    <option value="">Todas las materias</option>
                </select>
            </div>

            <div id="attendance-history-content" style="max-height: 500px; overflow-y: auto;"></div>

            <button onclick="closeAttendanceHistory()" style="width: 100%; padding: 12px; background: #f0f0f0; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 15px;">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal for Grades View -->
    <div class="modal" id="grades-modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span>üìù Calificaciones y Evaluaci√≥n</span>
                <button onclick="openCriteriaSettings()" style="padding: 6px 12px; background: #E3F2FD; border: none; border-radius: 5px; color: #1565C0; font-size: 12px; cursor: pointer; font-weight: 500;">
                    ‚öôÔ∏è Criterios
                </button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <select id="grades-subject-filter" onchange="updateGradesView()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                </select>
            </div>

            <!-- Criteria Summary -->
            <div id="criteria-summary" style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;"></div>

            <!-- Students Grades Table -->
            <div id="grades-table-container" style="overflow-x: auto;"></div>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="exportGradesToExcel()" style="flex: 1; padding: 12px; background: #E8F5E9; color: #2E7D32; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    üì• Exportar Calificaciones
                </button>
                <button onclick="closeGradesView()" style="flex: 1; padding: 12px; background: #f0f0f0; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Criteria Settings -->
    <div class="modal" id="criteria-settings-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">‚öôÔ∏è Configurar Criterios de Evaluaci√≥n</div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Define qu√© aspectos evaluar√°s y qu√© porcentaje representa cada uno. El total debe sumar 100%.</p>
                
                <div id="criteria-list" style="margin-bottom: 15px;"></div>

                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px; font-size: 14px;">‚ûï Agregar Nuevo Criterio</h4>
                    <div class="form-group">
                        <label>Nombre del Criterio</label>
                        <input type="text" id="new-criteria-name" placeholder="Ej: Trabajos en clase, Proyecto final">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>Porcentaje (%)</label>
                            <input type="number" id="new-criteria-percentage" min="0" max="100" placeholder="20">
                        </div>
                        <div class="form-group">
                            <label>Nota M√°xima</label>
                            <input type="number" id="new-criteria-max" min="1" value="100" placeholder="100">
                        </div>
                    </div>
                    <button onclick="addCriteria()" style="width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: 600; cursor: pointer;">
                        Agregar Criterio
                    </button>
                </div>

                <div id="total-percentage" style="text-align: center; padding: 10px; background: #E3F2FD; border-radius: 8px; font-weight: 600; color: #1565C0;"></div>
            </div>

            <button onclick="closeCriteriaSettings()" style="width: 100%; padding: 12px; background: #f0f0f0; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Cerrar
            </button>
        </div>
    </div>

    <script>
        // Schedule Data - Exact from image
        const scheduleData = {
            lunes: [
                { time: "8:00 - 9:00", subject: "RAZONAMIENTO L√ìGICO MATEM√ÅTICO", teacher: "Docente Tres Matematica", period: "1er periodo" },
                { time: "9:00 - 10:00", subject: "RAZONAMIENTO L√ìGICO MATEM√ÅTICO", teacher: "Docente Tres Matematica", period: "2do periodo" },
                { time: "10:00 - 10:15", subject: "RECREO", teacher: "", period: "Descanso", isBreak: true },
                { time: "10:15 - 11:15", subject: "LO: IDENTIDAD CULTURAL CON LOS PRINCIPIOS Y VALORES", teacher: "Lic. Hernan Mamani", period: "3er periodo" },
                { time: "11:15 - 12:15", subject: "LO: IDENTIDAD CULTURAL CON LOS PRINCIPIOS Y VALORES", teacher: "Lic. Hernan Mamani", period: "4to periodo" },
                { time: "12:15 - 12:30", subject: "RECREO", teacher: "", period: "Descanso", isBreak: true },
                { time: "12:30 - 13:30", subject: "FUNDAMENTOS DE LA ARITM√âTICA Y √ÅLGEBRA", teacher: "Lic. Eduardo Mercado", period: "5to periodo" },
                { time: "13:30 - 14:30", subject: "FUNDAMENTOS DE LA ARITM√âTICA Y √ÅLGEBRA", teacher: "Lic. Eduardo Mercado", period: "6to periodo" }
            ],
            martes: [
                { time: "8:00 - 9:00", subject: "HISTORIA CR√çTICA DE LA EDUCACI√ìN BOLIVIANA", teacher: "Docente Uno Sociales", period: "1er periodo" },
                { time: "9:00 - 10:00", subject: "HISTORIA CR√çTICA DE LA EDUCACI√ìN BOLIVIANA", teacher: "Docente Uno Sociales", period: "2do periodo" },
                { time: "10:00 - 10:15", subject: "RECREO", teacher: "", period: "Descanso", isBreak: true },
                { time: "10:15 - 11:15", subject: "FUNDAMENTOS DE LA ARITM√âTICA Y √ÅLGEBRA", teacher: "Docente Tres Matematica", period: "3er periodo" },
                { time: "11:15 - 12:15", subject: "FUNDAMENTOS DE LA ARITM√âTICA Y √ÅLGEBRA", teacher: "Lic. Eduardo Mercado", period: "4to periodo" },
                { time: "12:15 - 12:30", subject: "RECREO", teacher: "", period: "Descanso", isBreak: true },
                { time: "12:30 - 13:30", subject: "TALLER I INVESTIGACI√ìN EDUCATIVA Y PRODUCCI√ìN DE CONOCIMIENTOS", teacher: "Lic. Marlene Mamani", period: "5to periodo" },
                { time: "13:30 - 14:30", subject: "TALLER I INVESTIGACI√ìN EDUCATIVA Y PRODUCCI√ìN DE CONOCIMIENTOS", teacher: "Lic. Marlene Mamani", period: "6to periodo" }
            ],
            miercoles: [
                { time: "8:00 - 9:00", subject: "C√ÅLCULO APLICADA A LA TECNOLOG√çA", teacher: "Lic. Ivan Wily Copa", period: "1er periodo" },
                { time: "9:00 - 10:00", subject: "C√ÅLCULO APLICADA A LA TECNOLOG√çA", teacher: "Lic. Ivan Wily Copa", period: "2do periodo" },
                { time: "10:00 - 10:15", subject: "RECREO", teacher: "", period: "Descanso", isBreak: true },
                { time: "10:15 - 11:15", subject: "MODELO EDUCATIVO SOCIOCOMUNITARIO PRODUCTIVO", teacher: "Docente Dos Musica", period: "3er periodo" },
                { time: "11:15 - 12:15", subject: "MODELO EDUCATIVO SOCIOCOMUNITARIO PRODUCTIVO", teacher: "Docente Dos Musica", period: "4to periodo" },
                { time: "12:15 - 12:30", subject: "RECREO", teacher: "", period: "Descanso", isBreak: true },
                { time: "12:30 - 13:30", subject: "HISTORIA CR√çTICA DE LA EDUCACI√ìN BOLIVIANA", teacher: "Docente Uno Sociales", period: "5to periodo" },
                { time: "13:30 - 14:30", subject: "HISTORIA CR√çTICA DE LA EDUCACI√ìN BOLIVIANA", teacher: "Docente Uno Sociales", period: "6to periodo" }
            ],
            jueves: [
                { time: "8:00 - 9:00", subject: "GEOMETR√çA EUCLIDIANA Y GEOMETR√çA DE NUESTRAS CULTURAS", teacher: "Docente Tres Matematica", period: "1er periodo" },
                { time: "9:00 - 10:00", subject: "GEOMETR√çA EUCLIDIANA Y GEOMETR√çA DE NUESTRAS CULTURAS", teacher: "Docente Tres Matematica", period: "2do periodo" },
                { time: "10:00 - 10:15", subject: "RECREO", teacher: "", period: "Descanso", isBreak: true },
                { time: "10:15 - 11:15", subject: "C√ÅLCULO APLICADA A LA TECNOLOG√çA", teacher: "Lic. Ivan Wily Copa", period: "3er periodo" },
                { time: "11:15 - 12:15", subject: "C√ÅLCULO APLICADA A LA TECNOLOG√çA", teacher: "Lic. Ivan Wily Copa", period: "4to periodo" },
                { time: "12:15 - 12:30", subject: "RECREO", teacher: "", period: "Descanso", isBreak: true },
                { time: "12:30 - 13:30", subject: "TALLER I INVESTIGACI√ìN EDUCATIVA Y PRODUCCI√ìN DE CONOCIMIENTOS", teacher: "Lic. Marlene Mamani", period: "5to periodo" },
                { time: "13:30 - 14:30", subject: "TALLER I INVESTIGACI√ìN EDUCATIVA Y PRODUCCI√ìN DE CONOCIMIENTOS", teacher: "Lic. Marlene Mamani", period: "6to periodo" }
            ],
            viernes: [
                { time: "8:00 - 9:00", subject: "GEOMETR√çA EUCLIDIANA Y GEOMETR√çA DE NUESTRAS CULTURAS", teacher: "Docente Tres Matematica", period: "1er periodo" },
                { time: "9:00 - 10:00", subject: "GEOMETR√çA EUCLIDIANA Y GEOMETR√çA DE NUESTRAS CULTURAS", teacher: "Docente Tres Matematica", period: "2do periodo" },
                { time: "10:00 - 10:15", subject: "RECREO", teacher: "", period: "Descanso", isBreak: true },
                { time: "10:15 - 11:15", subject: "LO: IDENTIDAD CULTURAL CON LOS PRINCIPIOS Y VALORES", teacher: "ic. Hernan Mamani", period: "3er periodo" },
                { time: "11:15 - 12:15", subject: "LO: IDENTIDAD CULTURAL CON LOS PRINCIPIOS Y VALORES", teacher: "Lic. Hernan Mamani", period: "4to periodo" },
                { time: "12:15 - 12:30", subject: "RECREO", teacher: "", period: "Descanso", isBreak: true },
                { time: "12:30 - 13:30", subject: "PEDAGOG√çAS EN LOS PROCESOS DE APRENDIZAJE", teacher: "Lic. Angela Uruchi", period: "5to periodo" },
                { time: "13:30 - 14:30", subject: "PEDAGOG√çAS EN LOS PROCESOS DE APRENDIZAJE", teacher: "Lic Angela Uruchi", period: "6to periodo" }
            ],
            sabado: [
                // Empty by default - can be configured for weekend activities
            ],
            domingo: [
                // Empty by default - can be configured for weekend activities  
            ]
        };

        // State
        let currentWeekOffset = 0;
        let currentMonthOffset = 0;
        let selectedDay = 'lunes';
        let currentView = 'horario';
        let reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
        let selectedDate = null;
        let currentClassContext = null;
        let editingClassIndex = null;
        let editingDay = null;
        let reminderFilter = 'all';

        // Control de timeouts de notificaciones programadas (evita duplicados)
        const scheduledNotificationTimeouts = new Map();

        // Load custom schedule from localStorage or use default
        let customSchedule = JSON.parse(localStorage.getItem('customSchedule') || 'null');

        // Load custom categories or use defaults
        let customCategories = JSON.parse(localStorage.getItem('customCategories') || JSON.stringify([
            { id: 'tarea', name: 'Tarea', icon: 'üìù', color: '#4CAF50' },
            { id: 'examen', name: 'Examen', icon: 'üìÑ', color: '#f44336' },
            { id: 'exposicion', name: 'Exposici√≥n', icon: 'üé§', color: '#2196F3' },
            { id: 'evento', name: 'Evento', icon: 'üéâ', color: '#9C27B0' },
            { id: 'congreso', name: 'Congreso', icon: 'üéì', color: '#FF9800' },
            { id: 'otro', name: 'Otro', icon: 'üìå', color: '#607D8B' }
        ]));

        // Load subjects catalog
        let subjectsCatalog = JSON.parse(localStorage.getItem('subjectsCatalog') || JSON.stringify([
            'RAZONAMIENTO L√ìGICO MATEM√ÅTICO',
            'HISTORIA CR√çTICA DE LA EDUCACI√ìN BOLIVIANA',
            'C√ÅLCULO APLICADA A LA TECNOLOG√çA',
            'GEOMETR√çA EUCLIDIANA Y GEOMETR√çA DE NUESTRAS CULTURAS',
            'LO: IDENTIDAD CULTURAL CON LOS PRINCIPIOS Y VALORES',
            'FUNDAMENTOS DE LA ARITM√âTICA Y √ÅLGEBRA',
            'MODELO EDUCATIVO SOCIOCOMUNITARIO PRODUCTIVO',
            'TALLER I INVESTIGACI√ìN EDUCATIVA Y PRODUCCI√ìN DE CONOCIMIENTOS',
            'PEDAGOG√çAS EN LOS PROCESOS DE APRENDIZAJE'
        ]));

        // Load teachers catalog
        let teachersCatalog = JSON.parse(localStorage.getItem('teachersCatalog') || JSON.stringify([
            'Docente Tres Matematica',
            'Lic Raul Chui Mena',
            'Docente Dos Musica',
            'Lic. Ivan Wily Copa',
            'Lic. Hernan Mamani',
            'Lic. Eduardo Mercado',
            'Lic. Marlene Mamani',
            'Lic Angela Uruchi'
        ]));
// === NUEVO: Mapear materia ‚Üí docente autom√°ticamente ===
const subjectTeacherMap = {
    "RAZONAMIENTO L√ìGICO MATEM√ÅTICO": "Docente Tres Matematica",
    "HISTORIA CR√çTICA DE LA EDUCACI√ìN BOLIVIANA": "Docente Uno Sociales",
    "C√ÅLCULO APLICADA A LA TECNOLOG√çA": "Lic. Ivan Wily Copa",
    "GEOMETR√çA EUCLIDIANA Y GEOMETR√çA DE NUESTRAS CULTURAS": "Docente Tres Matematica",
    "LO: IDENTIDAD CULTURAL CON LOS PRINCIPIOS Y VALORES": "Lic. Hernan Mamani",
    "FUNDAMENTOS DE LA ARITM√âTICA Y √ÅLGEBRA": "Lic. Eduardo Mercado",
    "MODELO EDUCATIVO SOCIOCOMUNITARIO PRODUCTIVO": "Docente Dos Musica",
    "TALLER I INVESTIGACI√ìN EDUCATIVA Y PRODUCCI√ìN DE CONOCIMIENTOS": "Lic. Marlene Mamani",
    "PEDAGOG√çAS EN LOS PROCESOS DE APRENDIZAJE": "Lic Angela Uruchi"
};

// Funci√≥n para asignar docente autom√°ticamente
function getTeacherForSubject(subject) {
    return subjectTeacherMap[subject] || "Docente no asignado";
}
function saveClass() {
    // Crear objeto de clase con materia y docente autom√°tico
    const newClass = {
        time: selectedTimeSlot,                // hora seleccionada
        subject: selectedSubject,              // materia seleccionada
        teacher: getTeacherForSubject(selectedSubject), // docente asignado autom√°ticamente
        period: selectedPeriod,                // periodo seleccionado
        isBreak: false                          // marcar si es recreo o no
    };

    // Si estamos editando una clase existente
    if (editingClassIndex !== null && editingDay === selectedDay) {
        scheduleData[selectedDay][editingClassIndex] = newClass;
    } else {
        // Si es nueva clase
        if (!scheduleData[selectedDay]) scheduleData[selectedDay] = [];
        scheduleData[selectedDay].push(newClass);
    }

    // Guardar el horario actualizado en localStorage
    localStorage.setItem('customSchedule', JSON.stringify(scheduleData));

    // Limpiar variables temporales
    editingClassIndex = null;
    editingDay = null;

    // Refrescar la vista del horario
    renderSchedule();

    // Guardar en Firestore
    saveScheduleToFirestore();
}

// ==============================================
// SINCRONIZACI√ìN DE HORARIO CON FIRESTORE
// ==============================================

/**
 * Guarda el horario personalizado en Firestore
 */
async function saveScheduleToFirestore() {
    if (!currentUser) {
        console.log('‚ö†Ô∏è Usuario no autenticado, no se puede guardar en Firestore');
        return;
    }

    try {
        const schedule = customSchedule || scheduleData;
        await db.collection('users').doc(currentUser.uid)
            .collection('settings')
            .doc('customSchedule')
            .set({
                data: schedule,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        console.log('‚úÖ Horario guardado en Firestore');

        // Programar notificaciones autom√°ticas de clases
        await scheduleClassNotifications();
    } catch (error) {
        console.error('‚ùå Error al guardar horario en Firestore:', error);
    }
}

/**
 * Programa notificaciones autom√°ticas para todas las clases del horario
 */
async function scheduleClassNotifications() {
    if (!currentUser || !('Notification' in window)) {
        return;
    }

    try {
        const schedule = customSchedule || scheduleData;
        const daysOfWeek = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'];

        // Limpiar notificaciones programadas anteriores (en pr√≥xima versi√≥n)
        console.log('üìÖ Programando notificaciones de clases...');

        // Por cada d√≠a de la semana
        Object.keys(schedule).forEach(day => {
            const classes = schedule[day];
            if (!classes || classes.length === 0) return;

            // Por cada clase del d√≠a
            classes.forEach(cls => {
                if (cls.isBreak || !cls.time) return;

                // Extraer hora de inicio (formato "8:00 - 9:00")
                const timeMatch = cls.time.match(/^(\d+):(\d+)/);
                if (!timeMatch) return;

                const hour = parseInt(timeMatch[1]);
                const minute = parseInt(timeMatch[2]);

                // Crear notificaci√≥n recurrente para este d√≠a y hora
                scheduleRecurringClassNotification(day, hour, minute, cls);
            });
        });

        console.log('‚úÖ Notificaciones de clases programadas');
    } catch (error) {
        console.error('‚ùå Error al programar notificaciones:', error);
    }
}

/**
 * Programa notificaci√≥n recurrente para una clase espec√≠fica
 */
function scheduleRecurringClassNotification(dayName, hour, minute, classInfo) {
    // Esta funci√≥n programa una verificaci√≥n diaria para mostrar notificaciones
    // Se ejecutar√° cada vez que se cargue la app y verificar√° si hay clases pr√≥ximas

    const daysMap = {
        'domingo': 0,
        'lunes': 1,
        'martes': 2,
        'miercoles': 3,
        'jueves': 4,
        'viernes': 5,
        'sabado': 6
    };

    const targetDay = daysMap[dayName];
    if (targetDay === undefined) return;

    // Verificar si hoy es el d√≠a de esta clase
    const now = new Date();
    const currentDay = now.getDay();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();

    if (currentDay === targetDay) {
        // Calcular minutos hasta la clase
        const classTime = hour * 60 + minute;
        const nowTime = currentHour * 60 + currentMinute;
        const minutesUntilClass = classTime - nowTime;

        // Notificar 15 minutos antes
        if (minutesUntilClass > 0 && minutesUntilClass <= 15) {
            showClassNotification(classInfo, minutesUntilClass);
        }
    }
}

/**
 * Muestra notificaci√≥n de clase pr√≥xima
 */
async function showClassNotification(classInfo, minutesUntil) {
    if (Notification.permission === 'granted') {
        const notification = new Notification('üìö Clase Pr√≥xima', {
            body: `${classInfo.subject}\n‚è∞ En ${minutesUntil} minutos\nüë®‚Äçüè´ ${classInfo.teacher}`,
            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23006847" width="100" height="100"/><text x="50" y="50" font-size="50" text-anchor="middle" dy=".3em">üìö</text></svg>',
            tag: `class-${classInfo.subject}`,
            requireInteraction: true
        });

        notification.onclick = function() {
            window.focus();
            this.close();
        };
    }
}

// Verificar clases pr√≥ximas cada 5 minutos
setInterval(() => {
    if (currentUser && customSchedule) {
        scheduleClassNotifications();
    }
}, 5 * 60 * 1000);

        // Load periods catalog
        let periodsCatalog = JSON.parse(localStorage.getItem('periodsCatalog') || JSON.stringify([
            '1er periodo',
            '2do periodo',
            '3er periodo',
            '4to periodo',
            '5to periodo',
            '6to periodo',
            '7mo periodo',
            '8vo periodo',
            '9no periodo',
            'Descanso'
        ]));

        // Load time slots catalog
        let timeSlotsCatalog = JSON.parse(localStorage.getItem('timeSlotsCatalog') || JSON.stringify([
            '8:00 - 9:00',
            '9:00 - 10:00',
            '10:00 - 10:15',
            '10:15 - 11:15',
            '11:15 - 12:15',
            '12:15 - 12:30',
            '12:30 - 13:30',
            '13:30 - 14:30',
            '14:30 - 15:30',
            '15:30 - 16:30',
            '16:30 - 17:30'
        ]));

        // Load attendance records
        let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
        
        // Load students list
        let studentsList = JSON.parse(localStorage.getItem('studentsList') || JSON.stringify([
            'Yo (Mi asistencia)'
        ]));

        // Current attendance session
        let currentAttendanceDate = null;
        let currentAttendanceSubject = null;
        let currentSessionAttendance = {};

        // Academic Calendar Configuration
        let academicConfig = JSON.parse(localStorage.getItem('academicConfig') || JSON.stringify({
            startDate: '2026-02-09', // Inicio de clases - D√çA #1
            endDate: '2026-12-02',   // Finalizaci√≥n del desarrollo curricular
            midYearBreakStart: '2026-07-06', // Descanso pedag√≥gico (10 d√≠as h√°biles en 2do trimestre)
            midYearBreakEnd: '2026-07-17',
            holidays: [
                // FERIADOS ACAD√âMICOS 2026 - Solo los que S√ç se acatan en educaci√≥n
                // Seg√∫n Resoluci√≥n Ministerial 0001/2026 del Ministerio de Educaci√≥n
                { date: '2026-02-16', name: 'Carnaval' },
                { date: '2026-02-17', name: 'Carnaval' },
                { date: '2026-04-03', name: 'Viernes Santo' },
                { date: '2026-05-01', name: 'D√≠a del Trabajo' },
                { date: '2026-06-04', name: 'Corpus Christi' },
                { date: '2026-06-22', name: 'A√±o Nuevo Andino Amaz√≥nico' },
                { date: '2026-08-06', name: 'D√≠a de la Independencia' },
                { date: '2026-11-02', name: 'D√≠a de Todos los Difuntos' }
                // NOTA: El Ministerio de Educaci√≥n NO suspende clases por:
                // - A√±o Nuevo (vacaciones de fin de a√±o)
                // - Estado Plurinacional (no es feriado escolar)
                // - Feriados adicionales creados para turismo
                // - Navidad (vacaciones de fin de a√±o)
            ]
        }));

        // Calculate actual date for a given day of week and week offset
        function getActualDateForDay(dayName) {
            const dayMap = { 'lunes': 1, 'martes': 2, 'miercoles': 3, 'jueves': 4, 'viernes': 5, 'sabado': 6, 'domingo': 0 };
            const targetDayOfWeek = dayMap[dayName];
            
            // Start from TODAY and apply week offset
            const today = new Date();
            
            // Get Monday of current week
            const currentDay = today.getDay();
            const daysFromMonday = currentDay === 0 ? 6 : currentDay - 1; // If Sunday, 6 days from Monday
            const monday = new Date(today);
            monday.setDate(today.getDate() - daysFromMonday);
            monday.setHours(0, 0, 0, 0);
            
            // Apply week offset
            monday.setDate(monday.getDate() + (currentWeekOffset * 7));
            
            // Calculate target date from this Monday
            const resultDate = new Date(monday);
            if (targetDayOfWeek === 0) {
                // Sunday is 6 days after Monday
                resultDate.setDate(monday.getDate() + 6);
            } else {
                // Other days: Monday=1 is +0, Tuesday=2 is +1, etc.
                resultDate.setDate(monday.getDate() + (targetDayOfWeek - 1));
            }
            
            return resultDate;
        }

        // Calculate class day number (only counts actual class days)
        function getClassDayNumber(date) {
            const startDate = new Date(academicConfig.startDate);
            const endDate = new Date(academicConfig.endDate);
            
            // If before start or after end, return null
            if (date < startDate || date > endDate) {
                return null;
            }
            
            let dayCount = 0;
            let currentDate = new Date(startDate);
            
            while (currentDate <= date) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayOfWeek = currentDate.getDay();
                
                // Check if it's a class day (not holiday, not vacation, not weekend unless marked)
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isHoliday = academicConfig.holidays.some(h => h.date === dateStr);
                const isVacation = dateStr >= academicConfig.midYearBreakStart && dateStr <= academicConfig.midYearBreakEnd;
                const hasWeekendActivity = academicConfig.weekendActivities && academicConfig.weekendActivities.some(a => a.date === dateStr);
                
                // Count as class day if:
                // - Not a holiday
                // - Not in vacation
                // - Either weekday OR weekend with activity
                if (!isHoliday && !isVacation && (!isWeekend || hasWeekendActivity)) {
                    dayCount++;
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return dayCount;
        }

        function isDateExcluded(date) {
            const dateStr = date.toISOString().split('T')[0];
            
            // Check if it's a holiday
            if (academicConfig.holidays.some(h => h.date === dateStr)) {
                return true;
            }
            
            // Check if it's in mid-year break
            if (dateStr >= academicConfig.midYearBreakStart && dateStr <= academicConfig.midYearBreakEnd) {
                return true;
            }
            
            return false;
        }

        function isWeekend(date) {
            const day = date.getDay();
            return day === 0 || day === 6; // Sunday or Saturday
        }

        function hasWeekendActivity(date) {
            if (!academicConfig.weekendActivities) {
                academicConfig.weekendActivities = [];
            }
            const dateStr = date.toISOString().split('T')[0];
            return academicConfig.weekendActivities.some(a => a.date === dateStr);
        }

        // Evaluation criteria
        let evaluationCriteria = JSON.parse(localStorage.getItem('evaluationCriteria') || JSON.stringify([
            { id: 'asistencia', name: 'Asistencia', percentage: 20, maxScore: 100 },
            { id: 'participacion', name: 'Participaci√≥n', percentage: 20, maxScore: 100 },
            { id: 'tareas', name: 'Tareas', percentage: 30, maxScore: 100 },
            { id: 'examenes', name: 'Ex√°menes', percentage: 30, maxScore: 100 }
        ]));

        // Student grades
        let studentGrades = JSON.parse(localStorage.getItem('studentGrades') || '{}');

        // Initialize (handled at bottom of script)

        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    selectedDay = this.dataset.day;
                    renderSchedule();
                });
            });
        }

        function initNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    currentView = this.dataset.view;
                    
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(currentView + '-view').classList.add('active');
                    
                    if (currentView === 'calendario') {
                        updateCalendar();
                    } else if (currentView === 'recordatorios') {
                        renderReminders();
                    } else if (currentView === 'asistencia') {
                        renderAttendance();
                        populateAttendanceSubjectFilter();
                    }
                });
            });
        }

        function changeWeek(offset) {
            currentWeekOffset += offset;
            updateWeekDisplay();
            renderDayTabs(); // Update tabs with new dates
            renderSchedule(); // Update schedule
        }

        function updateWeekDisplay() {
            const today = new Date();
            
            // Get current Monday
            const currentDay = today.getDay();
            const daysFromMonday = currentDay === 0 ? 6 : currentDay - 1;
            const monday = new Date(today);
            monday.setDate(today.getDate() - daysFromMonday);
            monday.setHours(0, 0, 0, 0);
            
            // Apply week offset
            monday.setDate(monday.getDate() + (currentWeekOffset * 7));
            
            // Sunday is 6 days after Monday
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            // Check if they're in the same year
            const mondayYear = monday.getFullYear();
            const sundayYear = sunday.getFullYear();
            
            let dateRange;
            if (mondayYear === sundayYear) {
                // Same year: "16 feb - 22 feb 2026"
                const mondayStr = monday.toLocaleDateString('es-BO', { day: 'numeric', month: 'short' });
                const sundayStr = sunday.toLocaleDateString('es-BO', { day: 'numeric', month: 'short', year: 'numeric' });
                dateRange = `${mondayStr} - ${sundayStr}`;
            } else {
                // Different years: "30 dic 2025 - 5 ene 2026"
                const mondayStr = monday.toLocaleDateString('es-BO', { day: 'numeric', month: 'short', year: 'numeric' });
                const sundayStr = sunday.toLocaleDateString('es-BO', { day: 'numeric', month: 'short', year: 'numeric' });
                dateRange = `${mondayStr} - ${sundayStr}`;
            }
            
            document.getElementById('current-week').textContent = dateRange;
        }

        function renderDayTabs() {
            const tabsContainer = document.getElementById('day-tabs');
            if (!tabsContainer) return;
            
            const days = [
                { key: 'lunes', label: 'Lun' },
                { key: 'martes', label: 'Mar' },
                { key: 'miercoles', label: 'Mi√©' },
                { key: 'jueves', label: 'Jue' },
                { key: 'viernes', label: 'Vie' },
                { key: 'sabado', label: 'S√°b' },
                { key: 'domingo', label: 'Dom' }
            ];
            
            tabsContainer.innerHTML = days.map(day => {
                const date = getActualDateForDay(day.key);
                const dateStr = date.toISOString().split('T')[0];
                const dayNum = date.getDate();
                const monthShort = date.toLocaleDateString('es-BO', { month: 'short' });
                
                // Check if holiday
                const isHoliday = academicConfig.holidays.some(h => h.date === dateStr);
                
                // Special styling for weekend
                let style = '';
                if (day.key === 'sabado') {
                    style = 'background: #FFF3E0;';
                } else if (day.key === 'domingo') {
                    style = 'background: #FFEBEE;';
                }
                
                const isActive = selectedDay === day.key;
                const holidayClass = isHoliday ? 'holiday' : '';
                const activeClass = isActive ? 'active' : '';
                
                return `
                    <button class="tab ${activeClass} ${holidayClass}" 
                            data-day="${day.key}"
                            style="${style}"
                            onclick="changeDay('${day.key}')">
                        <div class="tab-day">${day.label}</div>
                        <div class="tab-date">${dayNum} ${monthShort}</div>
                    </button>
                `;
            }).join('');
        }

        function changeDay(day) {
            selectedDay = day;
            renderDayTabs();
            renderSchedule();
        }

        function renderSchedule() {
            const content = document.getElementById('schedule-content');
            const schedule = customSchedule || scheduleData;
            const classes = schedule[selectedDay] || [];
            
            // Get actual date being viewed
            const actualDate = getActualDateForDay(selectedDay);
            const viewingDateStr = actualDate.toISOString().split('T')[0];
            const todayDateStr = new Date().toISOString().split('T')[0];
            const isToday = viewingDateStr === todayDateStr;
            
            // Get current time (only relevant if viewing today)
            const now = new Date();
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTimeValue = currentHours * 60 + currentMinutes;
            
            // Check if viewing date is within academic period
            const startDate = new Date(academicConfig.startDate);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(academicConfig.endDate);
            endDate.setHours(0, 0, 0, 0);
            const viewingDate = new Date(actualDate);
            viewingDate.setHours(0, 0, 0, 0);
            
            const isBeforeAcademicStart = viewingDate < startDate;
            const isAfterAcademicEnd = viewingDate > endDate;
            
            // Get day name in Spanish for display
            const dayMap = { 1: 'lunes', 2: 'martes', 3: 'miercoles', 4: 'jueves', 5: 'viernes', 6: 'sabado', 0: 'domingo' };
            const viewingDayOfWeek = actualDate.getDay(); // 0-6
            const viewingDayName = dayMap[viewingDayOfWeek];
            
            // Add debug info banner
            const dayIndexMap = { 'lunes': 1, 'martes': 2, 'miercoles': 3, 'jueves': 4, 'viernes': 5, 'sabado': 6, 'domingo': 0 };
            const selectedDayIndex = dayIndexMap[selectedDay];
            
            // Determine day status using ACTUAL DATES not day of week
            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);
            
            let dayStatus;
            if (viewingDate < todayDate) {
                dayStatus = '‚úÖ D√çA PASADO (todo tachado)';
            } else if (viewingDate.getTime() === todayDate.getTime()) {
                dayStatus = 'üü¢ D√çA ACTUAL (progreso en tiempo real)';
            } else {
                dayStatus = '‚è≥ D√çA FUTURO (todo sin tachar)';
            }
            
            // Check if selected day is a holiday
            const dateKey = actualDate.toISOString().split('T')[0];
            const holiday = academicConfig.holidays.some(h => h.date === dateKey);
            const isInMidYearBreak = dateKey >= academicConfig.midYearBreakStart && dateKey <= academicConfig.midYearBreakEnd;
            
            // Check if it's a weekend without activities
            const dayOfWeek = actualDate.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const hasWeekendActivity = academicConfig.weekendActivities && 
                                      academicConfig.weekendActivities.some(a => a.date === dateKey);
            const isWeekendWithoutClasses = isWeekend && !hasWeekendActivity;
            
            // Get class day number (will be null for weekends without activities)
            const classDayNumber = getClassDayNumber(actualDate);
            const totalClassDays = getClassDayNumber(new Date(academicConfig.endDate));
            
            // Format complete date
            const completeDateStr = actualDate.toLocaleDateString('es-BO', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let holidayBanner = '';
            if (holiday) {
                const holidayInfo = academicConfig.holidays.find(h => h.date === dateKey);
                holidayBanner = `
                    <div style="background: linear-gradient(135deg, #FF9800, #FFA726); padding: 15px; border-radius: 10px; margin-bottom: 15px; color: white; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 5px;">üéâ</div>
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 5px;">${holidayInfo.name}</div>
                        <div style="font-size: 13px; opacity: 0.9;">D√çA FERIADO - NO HAY CLASES</div>
                        <div style="font-size: 12px; margin-top: 8px; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 5px;">
                            üìÖ ${completeDateStr}
                        </div>
                    </div>
                `;
            } else if (isInMidYearBreak) {
                holidayBanner = `
                    <div style="background: linear-gradient(135deg, #00BCD4, #00ACC1); padding: 15px; border-radius: 10px; margin-bottom: 15px; color: white; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 5px;">üèñÔ∏è</div>
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 5px;">Vacaciones de Medio A√±o</div>
                        <div style="font-size: 13px; opacity: 0.9;">DESCANSO - NO HAY CLASES</div>
                        <div style="font-size: 12px; margin-top: 8px; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 5px;">
                            üìÖ ${completeDateStr}
                        </div>
                    </div>
                `;
            } else if (isWeekendWithoutClasses) {
                // Banner for weekend without classes
                const dayName = selectedDay === 'sabado' ? 'S√ÅBADO' : 'DOMINGO';
                holidayBanner = `
                    <div style="background: linear-gradient(135deg, ${selectedDay === 'sabado' ? '#FF9800, #FFA726' : '#E91E63, #F06292'}); padding: 15px; border-radius: 10px; margin-bottom: 15px; color: white; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 5px;">${selectedDay === 'sabado' ? 'üèñÔ∏è' : 'üå¥'}</div>
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 5px;">HOY ES ${dayName}</div>
                        <div style="font-size: 13px; opacity: 0.9;">NO HAY CLASES PROGRAMADAS</div>
                        <div style="font-size: 12px; margin-top: 8px; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 5px;">
                            üìÖ ${completeDateStr}
                        </div>
                    </div>
                `;
            }
            
            // Add validation banner if outside academic period
            let validationBanner = '';
            if (isBeforeAcademicStart) {
                validationBanner = `
                    <div style="background: linear-gradient(135deg, #9E9E9E, #BDBDBD); padding: 15px; border-radius: 10px; margin-bottom: 15px; color: white; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 5px;">‚è∏Ô∏è</div>
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 5px;">ANTES DEL INICIO DE CLASES</div>
                        <div style="font-size: 13px; opacity: 0.9;">Las clases inician el ${new Date(academicConfig.startDate).toLocaleDateString('es-BO', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>
                    </div>
                `;
            } else if (isAfterAcademicEnd) {
                validationBanner = `
                    <div style="background: linear-gradient(135deg, #9E9E9E, #BDBDBD); padding: 15px; border-radius: 10px; margin-bottom: 15px; color: white; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 5px;">üèÅ</div>
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 5px;">DESPU√âS DEL FIN DE CLASES</div>
                        <div style="font-size: 13px; opacity: 0.9;">El per√≠odo acad√©mico finaliz√≥ el ${new Date(academicConfig.endDate).toLocaleDateString('es-BO', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>
                    </div>
                `;
            }
            
            const debugInfo = `
                <div style="background: #E3F2FD; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 12px;">
                    <strong>üïê Hora actual:</strong> ${currentHours.toString().padStart(2, '0')}:${currentMinutes.toString().padStart(2, '0')}<br>
                    <strong>üìÖ Hoy es:</strong> ${isToday ? viewingDayName : new Date().toLocaleDateString('es-BO', { weekday: 'long' })} (${isToday ? 'Viendo HOY' : 'Viendo otra fecha'})<br>
                    <strong>üëÄ Viendo:</strong> ${selectedDay.toUpperCase()}<br>
                    <strong>üìÜ Fecha completa:</strong> ${completeDateStr}<br>
                    ${!isWeekendWithoutClasses && !holiday && !isInMidYearBreak && !isBeforeAcademicStart && !isAfterAcademicEnd && classDayNumber ? `<strong>üìö D√≠a de clases:</strong> #${classDayNumber} de ${totalClassDays || '~200'} d√≠as<br>` : ''}
                    ${isWeekendWithoutClasses ? `<strong>üìö Fin de semana:</strong> NO HAY CLASES PROGRAMADAS<br>` : ''}
                    ${holiday ? `<strong>üéâ Feriado:</strong> ${academicConfig.holidays.find(h => h.date === dateKey).name}<br>` : ''}
                    ${isInMidYearBreak ? `<strong>üèñÔ∏è Vacaciones:</strong> DESCANSO DE MEDIO A√ëO<br>` : ''}
                    ${isBeforeAcademicStart ? `<strong>‚è∏Ô∏è Per√≠odo acad√©mico:</strong> A√∫n no inicia<br>` : ''}
                    ${isAfterAcademicEnd ? `<strong>üèÅ Per√≠odo acad√©mico:</strong> Ya finaliz√≥<br>` : ''}
                    <strong>üìä Estado:</strong> ${dayStatus}
                </div>
            `;
            
            content.innerHTML = validationBanner + holidayBanner + debugInfo + classes.map((cls, idx) => {
                // Check if this is the current period OR if this day already passed
                let isCurrent = false;
                let isPast = false;
                
                // Compare actual dates, not just day of week
                const now = new Date();
                const viewingDate = new Date(actualDate);
                viewingDate.setHours(0, 0, 0, 0);
                const todayDate = new Date(now);
                todayDate.setHours(0, 0, 0, 0);
                
                // Check if viewing date is before today
                if (viewingDate < todayDate) {
                    isPast = true; // Entire day is in the past
                } else if (viewingDate.getTime() === todayDate.getTime()) {
                    // It's today - check times
                    const times = cls.time.split(' - ');
                    const [startH, startM] = times[0].split(':').map(Number);
                    const [endH, endM] = times[1].split(':').map(Number);
                    const startTimeValue = startH * 60 + startM;
                    const endTimeValue = endH * 60 + endM;
                    
                    if (currentTimeValue >= startTimeValue && currentTimeValue < endTimeValue) {
                        isCurrent = true;
                    } else if (currentTimeValue >= endTimeValue) {
                        isPast = true;
                    }
                }
                
                if (cls.isBreak) {
                    return `
                        <div class="schedule-card break ${isCurrent ? 'current-period' : ''} ${isPast ? 'past-period' : ''}">
                            <div class="time">‚òï ${cls.time}</div>
                            <div class="subject">${cls.subject}</div>
                            ${isCurrent ? '<div class="current-badge">EN CURSO üü¢</div>' : ''}
                            ${isPast ? '<div class="past-badge">‚úÖ COMPLETADO</div>' : ''}
                        </div>
                    `;
                }
                
                // Check if this class is part of a merged group (consecutive periods of same subject)
                let mergedClass = '';
                const prevClass = idx > 0 ? classes[idx - 1] : null;
                const nextClass = idx < classes.length - 1 ? classes[idx + 1] : null;
                
                const isPrevSame = prevClass && !prevClass.isBreak && prevClass.subject === cls.subject && prevClass.teacher === cls.teacher;
                const isNextSame = nextClass && !nextClass.isBreak && nextClass.subject === cls.subject && nextClass.teacher === cls.teacher;
                
                if (!isPrevSame && isNextSame) {
                    mergedClass = 'merged-start';
                } else if (isPrevSame && isNextSame) {
                    mergedClass = 'merged-middle';
                } else if (isPrevSame && !isNextSame) {
                    mergedClass = 'merged-end';
                }
                
                return `
                    <div class="schedule-card ${mergedClass} ${isCurrent ? 'current-period' : ''} ${isPast ? 'past-period' : ''}" onclick="openClassModal('${selectedDay}', ${idx})">
                        <div class="period">${cls.period}</div>
                        <div class="time">‚è∞ ${cls.time}</div>
                        <div class="subject">${cls.subject}</div>
                        <div class="teacher">üë®‚Äçüè´ ${cls.teacher}</div>
                        ${isCurrent ? '<div class="current-badge">EN CURSO üü¢</div>' : ''}
                        ${isPast ? '<div class="past-badge">‚úÖ COMPLETADO</div>' : ''}
                        <div class="actions">
                            <button class="btn-note" onclick="event.stopPropagation(); addQuickNote('${selectedDay}', ${idx})">üìù Nota R√°pida</button>
                            <button class="btn-reminder" onclick="event.stopPropagation(); addReminderFor('${cls.subject.replace(/'/g, "\\'")}', '${selectedDay}')">‚è∞ Recordar</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Auto-refresh every minute to update highlighting
            if (isToday && currentView === 'horario') {
                setTimeout(() => renderSchedule(), 60000);
            }
        }

        function changeMonth(offset) {
            currentMonthOffset += offset;
            updateCalendar();
        }

        function updateCalendar() {
            const today = new Date();
            const targetDate = new Date(today.getFullYear(), today.getMonth() + currentMonthOffset, 1);
            
            const year = targetDate.getFullYear();
            const month = targetDate.getMonth();
            
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const daysContainer = document.getElementById('calendar-days');
            daysContainer.innerHTML = '';
            
            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                daysContainer.innerHTML += '<div class="day"></div>';
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const hasEvent = reminders.some(r => r.date === dateStr);
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                const isSelected = selectedDate === dateStr;
                const isHoliday = academicConfig.holidays.some(h => h.date === dateStr);
                
                const classes = ['day'];
                if (isToday) classes.push('today');
                if (isSelected) classes.push('selected');
                if (hasEvent) classes.push('has-event');
                if (isHoliday) classes.push('holiday');
                
                daysContainer.innerHTML += `
                    <div class="${classes.join(' ')}" 
                         onclick="selectDate('${dateStr}')" 
                         oncontextmenu="event.preventDefault(); toggleHolidayOnDate('${dateStr}'); return false;"
                         ontouchstart="dayTouchStart(event, '${dateStr}')"
                         ontouchend="dayTouchEnd()">${day}</div>
                `;
            }
            
            showEventsForDate(selectedDate || new Date().toISOString().split('T')[0]);
        }

        // Touch handlers for mobile long-press
        let touchTimer = null;
        function dayTouchStart(event, dateStr) {
            touchTimer = setTimeout(() => {
                toggleHolidayOnDate(dateStr);
            }, 800); // 800ms long press
        }

        function dayTouchEnd() {
            if (touchTimer) {
                clearTimeout(touchTimer);
                touchTimer = null;
            }
        }

        function selectDate(dateStr) {
            selectedDate = dateStr;
            updateCalendar();
        }

        function showEventsForDate(dateStr) {
            const dayEvents = document.getElementById('day-events');
            const events = reminders.filter(r => r.date === dateStr);
            const holiday = academicConfig.holidays.find(h => h.date === dateStr);
            
            let html = '';
            
            // Show holiday if exists
            if (holiday) {
                html += `
                    <div style="background: #FFF3E0; border-left: 4px solid #FF9800; padding: 12px; margin-bottom: 10px; border-radius: 8px;">
                        <div style="font-weight: 600; color: #E65100;">üéâ ${holiday.name}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">D√≠a Feriado</div>
                    </div>
                `;
            }
            
            // Show reminders

            if (events.length === 0) {
                dayEvents.innerHTML = '';
                return;
            }

            const date = parseLocalDate(dateStr);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

            dayEvents.innerHTML = `
                <h3 style="margin-bottom: 15px; font-size: 16px;">
                    ${date.toLocaleDateString('es-BO', options)}
                </h3>
                ${events.map(event => {
                    const category = getCategoryById(event.type);
                    return `
                        <div class="reminder-item ${event.type} ${event.completed ? 'completed' : ''}">
                            <div class="category-badge" style="background: ${category.color}22; color: ${category.color};">
                                ${category.icon} ${category.name.toUpperCase()}
                            </div>
                            <div class="title">${event.title}</div>
                            ${event.subject ? `<div style="font-size: 13px; color: #666;">${event.subject}</div>` : ''}
                            ${event.description ? `<div style="font-size: 13px; margin-top: 5px;">${event.description}</div>` : ''}
                            ${event.time ? `<div class="date">‚è∞ ${event.time}</div>` : ''}
                        </div>
                    `;
                }).join('')}
            `;
        }

        function renderReminders() {
            const content = document.getElementById('reminders-content');
            
            // Filter reminders
            let filteredReminders = reminders;
            if (reminderFilter === 'pending') {
                filteredReminders = reminders.filter(r => !r.completed);
            } else if (reminderFilter === 'completed') {
                filteredReminders = reminders.filter(r => r.completed);
            }
            
            if (filteredReminders.length === 0) {
                const emptyMessage = reminderFilter === 'completed' ? 
                    'No hay recordatorios completados' : 
                    reminderFilter === 'pending' ? 
                    'No hay recordatorios pendientes' : 
                    'No hay recordatorios';
                
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìù</div>
                        <div>${emptyMessage}</div>
                        <div style="font-size: 13px; margin-top: 5px;">Toca el bot√≥n + para agregar uno</div>
                    </div>
                `;
                return;
            }
            
            // Sort by date
            const sorted = [...filteredReminders].sort((a, b) => {
                // Completed items go to the end
                if (a.completed && !b.completed) return 1;
                if (!a.completed && b.completed) return -1;
                return parseLocalDate(a.date) - parseLocalDate(b.date);
            });

            content.innerHTML = sorted.map((reminder, originalIdx) => {
                const actualIdx = reminders.findIndex(r => r.id === reminder.id);
                const date = parseLocalDate(reminder.date);
                const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                const category = getCategoryById(reminder.type);
                
                return `
                    <div class="reminder-item ${reminder.type} ${reminder.completed ? 'completed' : ''}">
                        <div class="category-badge" style="background: ${category.color}22; color: ${category.color};">
                            ${category.icon} ${category.name.toUpperCase()}
                        </div>
                        <div class="title">${reminder.title}</div>
                        ${reminder.subject ? `<div style="font-size: 13px; color: #666; margin-bottom: 5px;">${reminder.subject}</div>` : ''}
                        ${reminder.description ? `<div style="font-size: 13px; margin-bottom: 5px;">${reminder.description}</div>` : ''}
                        <div class="date">üìÖ ${date.toLocaleDateString('es-BO', options)} ${reminder.time ? `‚è∞ ${reminder.time}` : ''}</div>
                        
                        <div class="reminder-actions">
                            <button class="btn-complete" onclick="toggleComplete(${actualIdx})">
                                ${reminder.completed ? '‚Ü©Ô∏è Desmarcar' : '‚úÖ Completar'}
                            </button>
                            <button class="btn-delete" onclick="deleteReminder(${actualIdx})">
                                üóë Eliminar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getCategoryById(id) {
            return customCategories.find(c => c.id === id) || customCategories[customCategories.length - 1];
        }

        async function toggleComplete(idx) {
            const reminder = reminders[idx];
            const newStatus = !reminder.completed;

            try {
                if (currentUser && (reminder.firestoreId || reminder.id)) {
                    const docId = reminder.firestoreId || String(reminder.id);

                    const updateData = {
                        completed: newStatus,
                        completedAt: newStatus ? firebase.firestore.FieldValue.serverTimestamp() : null
                    };

                    // Si hay evento en Google Calendar ‚Üí marcarlo como completado/pendiente
                    if (reminder.calendarEventId && gapiInited && gisInited) {
                        await markGoogleCalendarEventCompleted(reminder.calendarEventId, reminder, newStatus);
                    }

                    await db.collection('users').doc(currentUser.uid)
                        .collection('reminders')
                        .doc(docId)
                        .update(updateData);
                } else {
                    // Fallback a localStorage
                    reminders[idx].completed = newStatus;
                    localStorage.setItem('reminders', JSON.stringify(reminders));
                    renderReminders();
                    updateCalendar();
                }
                // UI se actualiza autom√°ticamente con el listener
            } catch (error) {
                console.error('Error al actualizar recordatorio:', error);
                alert('‚ùå Error al actualizar recordatorio');
            }
        }

        function filterReminders(filter) {
            reminderFilter = filter;
            
            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '#f0f0f0';
                    btn.style.color = '#666';
                }
            });
            
            renderReminders();
        }

        function openCategoryManager() {
            document.getElementById('category-modal').classList.add('active');
            renderCategoriesList();
        }

        function closeCategoryManager() {
            document.getElementById('category-modal').classList.remove('active');
        }

        function renderCategoriesList() {
            const listHTML = customCategories.map((cat, idx) => `
                <div style="background: ${cat.color}11; border: 2px solid ${cat.color}33; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">${cat.icon}</span>
                        <div>
                            <div style="font-weight: 600; color: ${cat.color};">${cat.name}</div>
                            <div style="font-size: 11px; color: #666;">ID: ${cat.id}</div>
                        </div>
                    </div>
                    ${idx >= 3 ? `
                        <button onclick="deleteCategory(${idx})" style="padding: 6px 12px; background: #FFEBEE; border: none; border-radius: 5px; color: #C62828; font-size: 12px; cursor: pointer; font-weight: 500;">
                            üóëÔ∏è Eliminar
                        </button>
                    ` : '<div style="font-size: 11px; color: #999;">Predeterminada</div>'}
                </div>
            `).join('');
            
            document.getElementById('categories-list').innerHTML = listHTML;
        }

        function addNewCategory() {
            const name = document.getElementById('new-category-name').value.trim();
            const icon = document.getElementById('new-category-icon').value.trim();
            const color = document.getElementById('new-category-color').value;
            
            if (!name || !icon) {
                alert('Por favor completa el nombre y el √≠cono');
                return;
            }
            
            const id = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            
            // Check if ID already exists
            if (customCategories.find(c => c.id === id)) {
                alert('Ya existe una categor√≠a con ese nombre');
                return;
            }
            
            customCategories.push({
                id: id,
                name: name,
                icon: icon,
                color: color
            });
            
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            
            // Clear form
            document.getElementById('new-category-name').value = '';
            document.getElementById('new-category-icon').value = '';
            document.getElementById('new-category-color').value = '#2196F3';
            
            renderCategoriesList();
            populateCategorySelect();
            
            alert('‚úÖ Categor√≠a agregada');
        }

        function deleteCategory(idx) {
            if (idx < 3) {
                alert('No puedes eliminar las categor√≠as predeterminadas');
                return;
            }
            
            const category = customCategories[idx];
            
            // Check if any reminders use this category
            const usageCount = reminders.filter(r => r.type === category.id).length;
            if (usageCount > 0) {
                if (!confirm(`Esta categor√≠a est√° siendo usada en ${usageCount} recordatorio(s). ¬øEst√°s seguro de eliminarla? Los recordatorios cambiar√°n a "Otro".`)) {
                    return;
                }
                
                // Update reminders to use 'otro'
                reminders.forEach(r => {
                    if (r.type === category.id) {
                        r.type = 'otro';
                    }
                });
                localStorage.setItem('reminders', JSON.stringify(reminders));
            }
            
            customCategories.splice(idx, 1);
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            
            renderCategoriesList();
            populateCategorySelect();
            renderReminders();
            
            alert('‚úÖ Categor√≠a eliminada');
        }

        function populateCategorySelect() {
            const select = document.getElementById('reminder-type');
            select.innerHTML = customCategories.map(cat => 
                `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`
            ).join('');
        }

        function populateReminderSubjectSelect() {
            const select = document.getElementById('reminder-subject');
            select.innerHTML = '<option value="">Seleccionar materia (opcional)</option>' +
                subjectsCatalog.map(subject => 
                    `<option value="${subject}">${subject}</option>`
                ).join('');
        }

        function openModal() {
            document.getElementById('reminder-modal').classList.add('active');
            populateCategorySelect();
            populateReminderSubjectSelect();
        }

        function closeModal() {
            document.getElementById('reminder-modal').classList.remove('active');
            clearForm();
        }

        function openClassModal(day, idx) {
            const schedule = customSchedule || scheduleData;
            const cls = schedule[day][idx];
            if (cls.isBreak) return;
            
            currentClassContext = { day, idx, class: cls };
            
            document.getElementById('class-modal-title').textContent = cls.subject;
            document.getElementById('class-modal-content').innerHTML = `
                <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                        <strong>üìÖ Horario:</strong> ${cls.time}
                    </div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                        <strong>üë®‚Äçüè´ Docente:</strong> ${cls.teacher}
                    </div>
                    <div style="font-size: 13px; color: #666;">
                        <strong>üìç Per√≠odo:</strong> ${cls.period}
                    </div>
                </div>
                <div style="background: white; border: 2px dashed #ddd; border-radius: 8px; padding: 15px; text-align: center;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                        Agrega notas, tareas o recordatorios para esta materia
                    </div>
                    <button onclick="addQuickNote('${day}', ${idx})" style="padding: 10px 20px; background: #E3F2FD; border: none; border-radius: 5px; color: #1565C0; font-weight: 500; cursor: pointer; margin-right: 10px;">
                        üìù Nota R√°pida
                    </button>
                </div>
            `;
            
            document.getElementById('class-modal').classList.add('active');
        }

        function closeClassModal() {
            document.getElementById('class-modal').classList.remove('active');
            currentClassContext = null;
        }

        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
            document.getElementById('settings-day-select').value = 'lunes';
            switchSettingsTab('schedule');
            loadDayForEditing();
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function switchSettingsTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.settings-tab').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.style.background = 'white';
                    btn.style.color = '#333';
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = '#666';
                }
            });

            // Show/hide tab content
            document.getElementById('settings-schedule-tab').style.display = tab === 'schedule' ? 'block' : 'none';
            document.getElementById('settings-subjects-tab').style.display = tab === 'subjects' ? 'block' : 'none';
            document.getElementById('settings-teachers-tab').style.display = tab === 'teachers' ? 'block' : 'none';
            document.getElementById('settings-periods-tab').style.display = tab === 'periods' ? 'block' : 'none';
            document.getElementById('settings-times-tab').style.display = tab === 'times' ? 'block' : 'none';

            // Load content for the tab
            if (tab === 'subjects') {
                renderSubjectsList();
            } else if (tab === 'teachers') {
                renderTeachersList();
            } else if (tab === 'periods') {
                renderPeriodsList();
            } else if (tab === 'times') {
                renderTimeSlotsList();
            } else if (tab === 'schedule') {
                loadDayForEditing();
            }
        }

        function renderPeriodsList() {
            const listHTML = periodsCatalog.map((period, idx) => `
                <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 14px;">${period}</div>
                    </div>
                    <button onclick="deletePeriod(${idx})" style="padding: 6px 12px; background: #FFEBEE; border: none; border-radius: 5px; color: #C62828; font-size: 12px; cursor: pointer; font-weight: 500;">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
            
            document.getElementById('periods-list').innerHTML = listHTML || '<div style="text-align: center; color: #999; padding: 20px;">No hay per√≠odos. Agrega tu primer per√≠odo abajo.</div>';
        }

        function renderTimeSlotsList() {
            const listHTML = timeSlotsCatalog.map((slot, idx) => `
                <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 14px;">‚è∞ ${slot}</div>
                    </div>
                    <button onclick="deleteTimeSlot(${idx})" style="padding: 6px 12px; background: #FFEBEE; border: none; border-radius: 5px; color: #C62828; font-size: 12px; cursor: pointer; font-weight: 500;">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
            
            document.getElementById('times-list').innerHTML = listHTML || '<div style="text-align: center; color: #999; padding: 20px;">No hay horarios. Agrega tu primer horario abajo.</div>';
        }

        function addPeriod() {
            const name = document.getElementById('new-period-name').value.trim();
            
            if (!name) {
                alert('Por favor ingresa el nombre del per√≠odo');
                return;
            }

            if (periodsCatalog.includes(name)) {
                alert('Este per√≠odo ya existe en el cat√°logo');
                return;
            }

            periodsCatalog.push(name);
            localStorage.setItem('periodsCatalog', JSON.stringify(periodsCatalog));

            document.getElementById('new-period-name').value = '';
            renderPeriodsList();
            populatePeriodSelect();

            alert('‚úÖ Per√≠odo agregado al cat√°logo');
        }

        function deletePeriod(idx) {
            const period = periodsCatalog[idx];
            
            if (!confirm(`¬øEliminar "${period}" del cat√°logo?`)) {
                return;
            }

            periodsCatalog.splice(idx, 1);
            localStorage.setItem('periodsCatalog', JSON.stringify(periodsCatalog));

            renderPeriodsList();
            populatePeriodSelect();

            alert('‚úÖ Per√≠odo eliminado');
        }

        function addTimeSlot() {
            const start = document.getElementById('new-time-start').value;
            const end = document.getElementById('new-time-end').value;
            
            if (!start || !end) {
                alert('Por favor ingresa hora de inicio y fin');
                return;
            }

            const slot = `${start} - ${end}`;

            if (timeSlotsCatalog.includes(slot)) {
                alert('Este horario ya existe en el cat√°logo');
                return;
            }

            timeSlotsCatalog.push(slot);
            localStorage.setItem('timeSlotsCatalog', JSON.stringify(timeSlotsCatalog));

            document.getElementById('new-time-start').value = '';
            document.getElementById('new-time-end').value = '';
            renderTimeSlotsList();
            populateTimeSlotSelect();

            alert('‚úÖ Horario agregado al cat√°logo');
        }

        function deleteTimeSlot(idx) {
            const slot = timeSlotsCatalog[idx];
            
            if (!confirm(`¬øEliminar "${slot}" del cat√°logo?`)) {
                return;
            }

            timeSlotsCatalog.splice(idx, 1);
            localStorage.setItem('timeSlotsCatalog', JSON.stringify(timeSlotsCatalog));

            renderTimeSlotsList();
            populateTimeSlotSelect();

            alert('‚úÖ Horario eliminado');
        }

        function populatePeriodSelect() {
            const select = document.getElementById('edit-period');
            select.innerHTML = periodsCatalog.map(period => 
                `<option value="${period}">${period}</option>`
            ).join('');
        }

        function populateTimeSlotSelect() {
            const select = document.getElementById('edit-time-slot');
            select.innerHTML = timeSlotsCatalog.map(slot => 
                `<option value="${slot}">${slot}</option>`
            ).join('');
        }

        function openQuickAddPeriod() {
            const name = prompt('Nombre del nuevo per√≠odo (Ej: 7mo periodo):');
            if (name && name.trim()) {
                if (periodsCatalog.includes(name.trim())) {
                    alert('Este per√≠odo ya existe');
                    return;
                }
                periodsCatalog.push(name.trim());
                localStorage.setItem('periodsCatalog', JSON.stringify(periodsCatalog));
                populatePeriodSelect();
                document.getElementById('edit-period').value = name.trim();
                alert('‚úÖ Per√≠odo agregado');
            }
        }

        function renderAttendance() {
            // Set default date to today if not set
            if (!currentAttendanceDate) {
                currentAttendanceDate = new Date().toISOString().split('T')[0];
            }
            
            // Set default subject if not set
            if (!currentAttendanceSubject && subjectsCatalog.length > 0) {
                currentAttendanceSubject = subjectsCatalog[0];
            }
            
            // Update pickers
            document.getElementById('attendance-date-picker').value = currentAttendanceDate;
            
            const subjectPicker = document.getElementById('attendance-subject-picker');
            subjectPicker.innerHTML = subjectsCatalog.map(subject => 
                `<option value="${subject}" ${subject === currentAttendanceSubject ? 'selected' : ''}>${subject}</option>`
            ).join('');
            
            // Load existing attendance for this date/subject
            loadCurrentSessionAttendance();
            
            // Calculate statistics
            const stats = calculateSessionStats();
            
            // Render statistics
            document.getElementById('attendance-stats').innerHTML = `
                <div style="background: #E8F5E9; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 20px; font-weight: 600; color: #2E7D32;">${stats.present}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 3px;">‚úÖ Presente</div>
                </div>
                <div style="background: #FFF3E0; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 20px; font-weight: 600; color: #E65100;">${stats.late}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 3px;">‚è∞ Atrasos</div>
                </div>
                <div style="background: #FFEBEE; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 20px; font-weight: 600; color: #C62828;">${stats.absent}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 3px;">‚ùå Faltas</div>
                </div>
                <div style="background: #E3F2FD; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 20px; font-weight: 600; color: #1565C0;">${stats.justified}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 3px;">üìã Justif.</div>
                </div>
            `;
            
            // Render student roster
            renderStudentRoster();
        }

        function loadCurrentSessionAttendance() {
            currentSessionAttendance = {};
            
            // Load from saved records
            attendanceRecords.forEach(record => {
                if (record.date === currentAttendanceDate && record.subject === currentAttendanceSubject) {
                    currentSessionAttendance[record.student] = {
                        status: record.status,
                        notes: record.notes || '',
                        id: record.id
                    };
                }
            });
        }

        function calculateSessionStats() {
            const stats = { present: 0, late: 0, absent: 0, justified: 0 };
            
            Object.values(currentSessionAttendance).forEach(att => {
                if (att.status === 'present') stats.present++;
                else if (att.status === 'late') stats.late++;
                else if (att.status === 'absent') stats.absent++;
                else if (att.status === 'justified') stats.justified++;
            });
            
            return stats;
        }

        function renderStudentRoster() {
            const roster = document.getElementById('attendance-roster');
            
            if (studentsList.length === 0) {
                roster.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <div>No hay estudiantes</div>
                        <div style="font-size: 13px; margin-top: 5px;">Toca "‚öôÔ∏è Estudiantes" para agregar</div>
                    </div>
                `;
                return;
            }
            
            roster.innerHTML = studentsList.map(student => {
                const attendance = currentSessionAttendance[student];
                const status = attendance ? attendance.status : null;
                const notes = attendance ? attendance.notes : '';
                
                return `
                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 4px solid ${status ? getStatusColor(status) : '#ddd'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 15px; margin-bottom: 5px;">
                                    ${student}
                                </div>
                                ${status ? `
                                    <div style="display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${getStatusBg(status)}; color: ${getStatusColor(status)};">
                                        ${getStatusIcon(status)} ${getStatusText(status)}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${notes ? `
                            <div style="background: #f5f5f5; padding: 8px; border-radius: 5px; font-size: 13px; margin-bottom: 10px;">
                                üí¨ ${notes}
                            </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            <button onclick="markAttendance('${student.replace(/'/g, "\\'")}', 'present')" style="padding: 10px; border: none; border-radius: 5px; background: ${status === 'present' ? '#4CAF50' : '#E8F5E9'}; color: ${status === 'present' ? 'white' : '#2E7D32'}; font-size: 12px; cursor: pointer; font-weight: 600;">
                                ‚úÖ Presente
                            </button>
                            <button onclick="markAttendance('${student.replace(/'/g, "\\'")}', 'late')" style="padding: 10px; border: none; border-radius: 5px; background: ${status === 'late' ? '#FF9800' : '#FFF3E0'}; color: ${status === 'late' ? 'white' : '#E65100'}; font-size: 12px; cursor: pointer; font-weight: 600;">
                                ‚è∞ Atraso
                            </button>
                            <button onclick="markAttendance('${student.replace(/'/g, "\\'")}', 'absent')" style="padding: 10px; border: none; border-radius: 5px; background: ${status === 'absent' ? '#f44336' : '#FFEBEE'}; color: ${status === 'absent' ? 'white' : '#C62828'}; font-size: 12px; cursor: pointer; font-weight: 600;">
                                ‚ùå Falta
                            </button>
                            <button onclick="markAttendance('${student.replace(/'/g, "\\'")}', 'justified')" style="padding: 10px; border: none; border-radius: 5px; background: ${status === 'justified' ? '#2196F3' : '#E3F2FD'}; color: ${status === 'justified' ? 'white' : '#1565C0'}; font-size: 12px; cursor: pointer; font-weight: 600;">
                                üìã Justif.
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusColor(status) {
            const colors = {
                present: '#4CAF50',
                late: '#FF9800',
                absent: '#f44336',
                justified: '#2196F3'
            };
            return colors[status] || '#999';
        }

        function getStatusBg(status) {
            const colors = {
                present: '#E8F5E9',
                late: '#FFF3E0',
                absent: '#FFEBEE',
                justified: '#E3F2FD'
            };
            return colors[status] || '#f5f5f5';
        }

        function getStatusIcon(status) {
            const icons = {
                present: '‚úÖ',
                late: '‚è∞',
                absent: '‚ùå',
                justified: 'üìã'
            };
            return icons[status] || '‚ùì';
        }

        function getStatusText(status) {
            const texts = {
                present: 'Presente',
                late: 'Atraso',
                absent: 'Falta',
                justified: 'Justificado'
            };
            return texts[status] || 'Sin marcar';
        }

        function markAttendance(student, status) {
            // Ask for notes if late, absent, or justified
            let notes = '';
            if (status === 'late' || status === 'absent' || status === 'justified') {
                const prompts = {
                    late: '‚è∞ Motivo del atraso (opcional):',
                    absent: '‚ùå Motivo de la falta (opcional):',
                    justified: 'üìã Justificaci√≥n:'
                };
                notes = prompt(prompts[status]) || '';
            }
            
            // Update or create record
            const existingRecord = attendanceRecords.find(r => 
                r.date === currentAttendanceDate && 
                r.subject === currentAttendanceSubject && 
                r.student === student
            );
            
            if (existingRecord) {
                existingRecord.status = status;
                existingRecord.notes = notes;
            } else {
                attendanceRecords.push({
                    id: Date.now(),
                    date: currentAttendanceDate,
                    subject: currentAttendanceSubject,
                    student: student,
                    status: status,
                    notes: notes
                });
            }
            
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            // Reload current session
            renderAttendance();
        }

        function updateAttendanceDate() {
            currentAttendanceDate = document.getElementById('attendance-date-picker').value;
            renderAttendance();
        }

        function updateAttendanceSubject() {
            currentAttendanceSubject = document.getElementById('attendance-subject-picker').value;
            renderAttendance();
        }

        function markAllPresent() {
            if (!confirm('¬øMarcar TODOS los estudiantes como PRESENTES?')) {
                return;
            }
            
            studentsList.forEach(student => {
                const existingRecord = attendanceRecords.find(r => 
                    r.date === currentAttendanceDate && 
                    r.subject === currentAttendanceSubject && 
                    r.student === student
                );
                
                if (existingRecord) {
                    existingRecord.status = 'present';
                    existingRecord.notes = '';
                } else {
                    attendanceRecords.push({
                        id: Date.now() + Math.random(),
                        date: currentAttendanceDate,
                        subject: currentAttendanceSubject,
                        student: student,
                        status: 'present',
                        notes: ''
                    });
                }
            });
            
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            renderAttendance();
            
            alert('‚úÖ Todos marcados como presentes');
        }

        function clearAllAttendance() {
            if (!confirm('¬øLimpiar toda la asistencia de esta sesi√≥n?')) {
                return;
            }
            
            attendanceRecords = attendanceRecords.filter(r => 
                !(r.date === currentAttendanceDate && r.subject === currentAttendanceSubject)
            );
            
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            renderAttendance();
            
            alert('üîÑ Asistencia limpiada');
        }

        function openAttendanceHistory() {
            document.getElementById('attendance-history-modal').classList.add('active');
            
            // Populate subject filter
            document.getElementById('history-subject-filter').innerHTML = 
                '<option value="">Todas las materias</option>' +
                subjectsCatalog.map(subject => 
                    `<option value="${subject}">${subject}</option>`
                ).join('');
            
            renderAttendanceHistory();
        }

        function closeAttendanceHistory() {
            document.getElementById('attendance-history-modal').classList.remove('active');
        }

        function filterHistory() {
            renderAttendanceHistory();
        }

        function renderAttendanceHistory() {
            const content = document.getElementById('attendance-history-content');
            const filter = document.getElementById('history-subject-filter').value;
            
            let filtered = attendanceRecords;
            if (filter) {
                filtered = attendanceRecords.filter(r => r.subject === filter);
            }
            
            if (filtered.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìä</div>
                        <div>No hay historial</div>
                    </div>
                `;
                return;
            }
            
            // Group by date and subject
            const grouped = {};
            filtered.forEach(record => {
                const key = `${record.date}|${record.subject}`;
                if (!grouped[key]) {
                    grouped[key] = [];
                }
                grouped[key].push(record);
            });
            
            // Sort by date descending
            const sortedKeys = Object.keys(grouped).sort((a, b) => {
                const dateA = a.split('|')[0];
                const dateB = b.split('|')[0];
                return new Date(dateB) - new Date(dateA);
            });
            
            content.innerHTML = sortedKeys.map(key => {
                const [date, subject] = key.split('|');
                const records = grouped[key];
                const dateObj = new Date(date);
                const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                
                const stats = {
                    present: records.filter(r => r.status === 'present').length,
                    late: records.filter(r => r.status === 'late').length,
                    absent: records.filter(r => r.status === 'absent').length,
                    justified: records.filter(r => r.status === 'justified').length
                };
                
                return `
                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 5px;">${subject}</div>
                        <div style="font-size: 13px; color: #666; margin-bottom: 10px;">üìÖ ${dateObj.toLocaleDateString('es-BO', options)}</div>
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px;">
                            <div style="background: #E8F5E9; padding: 8px; border-radius: 5px; text-align: center;">
                                <div style="font-weight: 600; color: #2E7D32;">${stats.present}</div>
                                <div style="font-size: 10px; color: #666;">Presente</div>
                            </div>
                            <div style="background: #FFF3E0; padding: 8px; border-radius: 5px; text-align: center;">
                                <div style="font-weight: 600; color: #E65100;">${stats.late}</div>
                                <div style="font-size: 10px; color: #666;">Atraso</div>
                            </div>
                            <div style="background: #FFEBEE; padding: 8px; border-radius: 5px; text-align: center;">
                                <div style="font-weight: 600; color: #C62828;">${stats.absent}</div>
                                <div style="font-size: 10px; color: #666;">Falta</div>
                            </div>
                            <div style="background: #E3F2FD; padding: 8px; border-radius: 5px; text-align: center;">
                                <div style="font-weight: 600; color: #1565C0;">${stats.justified}</div>
                                <div style="font-size: 10px; color: #666;">Justif.</div>
                            </div>
                        </div>
                        
                        <button onclick="viewSessionDetails('${date}', '${subject.replace(/'/g, "\\'")}' )" style="width: 100%; padding: 8px; background: #f5f5f5; border: none; border-radius: 5px; color: #666; font-size: 12px; cursor: pointer; font-weight: 500;">
                            üëÅÔ∏è Ver Detalles
                        </button>
                    </div>
                `;
            }).join('');
        }

        function viewSessionDetails(date, subject) {
            const records = attendanceRecords.filter(r => r.date === date && r.subject === subject);
            
            let details = `üìä Asistencia Detallada\n\n`;
            details += `Fecha: ${new Date(date).toLocaleDateString('es-BO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n`;
            details += `Materia: ${subject}\n\n`;
            details += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n`;
            
            records.forEach(record => {
                details += `${getStatusIcon(record.status)} ${record.student}\n`;
                details += `   Estado: ${getStatusText(record.status)}\n`;
                if (record.notes) {
                    details += `   Notas: ${record.notes}\n`;
                }
                details += `\n`;
            });
            
            alert(details);
        }


        // Event Listeners for modals (click backdrop to close)
        document.getElementById('attendance-settings-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAttendanceSettings();
            }
        });

        document.getElementById('attendance-history-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAttendanceHistory();
            }
        });

        // Export to Excel function
        function openAttendanceSettings() {
            document.getElementById('attendance-settings-modal').classList.add('active');
            renderStudentsList();
        }

        function closeAttendanceSettings() {
            document.getElementById('attendance-settings-modal').classList.remove('active');
            renderAttendance();
        }

        function renderStudentsList() {
            const listHTML = studentsList.map((student, idx) => `
                <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 14px;">üë§ ${student}</div>
                    </div>
                    <button onclick="deleteStudent(${idx})" style="padding: 6px 12px; background: #FFEBEE; border: none; border-radius: 5px; color: #C62828; font-size: 12px; cursor: pointer; font-weight: 500;">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
            
            document.getElementById('students-list').innerHTML = listHTML || '<div style="text-align: center; color: #999; padding: 20px;">No hay estudiantes. Agrega el primero abajo.</div>';
        }

        function addStudent() {
            const name = document.getElementById('new-student-name').value.trim();
            
            if (!name) {
                alert('Por favor ingresa el nombre del estudiante');
                return;
            }

            if (studentsList.includes(name)) {
                alert('Este estudiante ya existe');
                return;
            }

            studentsList.push(name);
            localStorage.setItem('studentsList', JSON.stringify(studentsList));

            document.getElementById('new-student-name').value = '';
            renderStudentsList();

            alert('‚úÖ Estudiante agregado');
        }

        function deleteStudent(idx) {
            const student = studentsList[idx];
            
            if (!confirm(`¬øEliminar a "${student}"?\n\nTambi√©n se eliminar√°n todos sus registros de asistencia.`)) {
                return;
            }

            // Remove student
            studentsList.splice(idx, 1);
            localStorage.setItem('studentsList', JSON.stringify(studentsList));

            // Remove all attendance records for this student
            attendanceRecords = attendanceRecords.filter(r => r.student !== student);
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));

            renderStudentsList();

            alert('‚úÖ Estudiante eliminado junto con su historial');
        }

        // NOTIFICATION SYSTEM
        
        // Request notification permissions on load
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Este navegador no soporta notificaciones');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                return true;
            }
            
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            
            return false;
        }

        // scheduleNotification: alias legacy ‚Üí usa scheduleWebNotification (definida en el segundo bloque de script)
function scheduleNotification(reminder) {
    if (typeof scheduleWebNotification === 'function') {
        scheduleWebNotification(reminder);
    }
}
        // Show notification
async function showNotification(reminder, customTitle = null) {
    if (Notification.permission !== 'granted') return;
    
    const category = getCategoryById(reminder.type);
    const title = customTitle || `${category.icon} ${category.name}`;
    const body = `${reminder.title}\n${reminder.subject ? 'üìö ' + reminder.subject : ''}\n${reminder.description || ''}`;
    
    // Usar Service Worker si est√° disponible
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        try {
            const registration = await navigator.serviceWorker.ready;
            await registration.showNotification(title, {
                body: body,
                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23006847"/><text x="50" y="50" text-anchor="middle" dominant-baseline="middle" font-size="50" fill="white">üìÖ</text></svg>',
                badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23006847"/></svg>',
                tag: `reminder-${reminder.id}`,
                requireInteraction: true,
                vibrate: [200, 100, 200],
                data: { reminderId: reminder.id },
                actions: [
                    { action: 'complete', title: '‚úÖ Completar', icon: '‚úÖ' },
                    { action: 'view', title: 'üëÅÔ∏è Ver detalles', icon: 'üëÅÔ∏è' }
                ]
            });
            return;
        } catch (e) {
            console.log('Service Worker notification failed, using fallback', e);
        }
    }
    
    // Fallback para navegadores sin Service Worker
    const notification = new Notification(title, {
        body: body,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23006847"/><text x="50" y="50" text-anchor="middle" dominant-baseline="middle" font-size="50" fill="white">üìÖ</text></svg>',
        tag: `reminder-${reminder.id}`,
        requireInteraction: true,
        vibrate: [200, 100, 200]
    });
            
            notification.onclick = function() {
                window.focus();
                // Switch to reminders view
                document.querySelector('[data-view="recordatorios"]').click();
                notification.close();
            };
        }

// Verificar notificaciones programadas cada minuto
setInterval(function() {
    const now = new Date();
    const scheduled = JSON.parse(localStorage.getItem('scheduledNotifications') || '[]');
    
    scheduled.forEach(function(item, index) {
        if (!item.notified) {
            const scheduledTime = new Date(item.datetime);
            const diff = scheduledTime - now;
            
            // Notificar si es tiempo (con 1 minuto de margen)
            if (diff <= 60000 && diff >= -60000) {
                const reminder = reminders.find(r => r.id === item.id);
                if (reminder && !reminder.completed) {
                    showNotification(reminder);
                    item.notified = true;
                    localStorage.setItem('scheduledNotifications', JSON.stringify(scheduled));
                }
            }
        }
    });
    
    // Limpiar notificaciones antiguas (m√°s de 1 d√≠a en el pasado)
    const filtered = scheduled.filter(item => {
        const scheduledTime = new Date(item.datetime);
        return (now - scheduledTime) < 86400000;
    });
    if (filtered.length !== scheduled.length) {
        localStorage.setItem('scheduledNotifications', JSON.stringify(filtered));
    }
}, 30000); // Cada 30 segundos

        // DARK MODE FUNCTIONS
        
        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            localStorage.setItem('theme', theme);
            updateThemeButtons();
        }

        function updateThemeButtons() {
            const isDark = document.body.classList.contains('dark-mode');
            const lightBtn = document.getElementById('theme-light-btn');
            const darkBtn = document.getElementById('theme-dark-btn');
            
            if (lightBtn && darkBtn) {
                if (isDark) {
                    lightBtn.style.background = '#424242';
                    lightBtn.style.color = '#E0E0E0';
                    lightBtn.style.border = '2px solid #424242';
                    darkBtn.style.background = '#00A86B';
                    darkBtn.style.color = 'white';
                    darkBtn.style.border = '2px solid #00A86B';
                } else {
                    lightBtn.style.background = '#006847';
                    lightBtn.style.color = 'white';
                    lightBtn.style.border = '2px solid #006847';
                    darkBtn.style.background = 'white';
                    darkBtn.style.color = '#333';
                    darkBtn.style.border = '2px solid #ddd';
                }
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }

        // ACADEMIC CALENDAR AND HOLIDAYS FUNCTIONS
        
        function saveAcademicConfig() {
            academicConfig.startDate = document.getElementById('academic-start-date').value;
            academicConfig.endDate = document.getElementById('academic-end-date').value;
            academicConfig.midYearBreakStart = document.getElementById('midyear-start').value;
            academicConfig.midYearBreakEnd = document.getElementById('midyear-end').value;
            
            localStorage.setItem('academicConfig', JSON.stringify(academicConfig));
            alert('‚úÖ Configuraci√≥n acad√©mica guardada');
            renderSchedule(); // Refresh to show new dates
        }

        function loadAcademicConfigForm() {
            document.getElementById('academic-start-date').value = academicConfig.startDate;
            document.getElementById('academic-end-date').value = academicConfig.endDate;
            document.getElementById('midyear-start').value = academicConfig.midYearBreakStart;
            document.getElementById('midyear-end').value = academicConfig.midYearBreakEnd;
            renderHolidaysList();
            updateNotificationStatus();
            updateThemeButtons();
        }

        function updateNotificationStatus() {
            const statusDiv = document.getElementById('notification-status');
            if (!statusDiv) return;
            
            if (!('Notification' in window)) {
                statusDiv.innerHTML = '‚ùå Tu navegador no soporta notificaciones';
                statusDiv.style.background = '#FFEBEE';
                return;
            }
            
            if (Notification.permission === 'granted') {
                statusDiv.innerHTML = '‚úÖ Notificaciones HABILITADAS<br><span style="font-size: 11px;">Recibir√°s alertas en tiempo real</span>';
                statusDiv.style.background = '#E8F5E9';
            } else if (Notification.permission === 'denied') {
                statusDiv.innerHTML = '‚ùå Notificaciones BLOQUEADAS<br><span style="font-size: 11px;">Ve a configuraci√≥n del navegador para permitirlas</span>';
                statusDiv.style.background = '#FFEBEE';
            } else {
                statusDiv.innerHTML = '‚è≥ Notificaciones DESHABILITADAS<br><span style="font-size: 11px;">Toca el bot√≥n abajo para activarlas</span>';
                statusDiv.style.background = '#FFF3E0';
            }
        }

        async function enableNotifications() {
            const hasPermission = await requestNotificationPermission();
            
            if (hasPermission) {
                updateNotificationStatus();
                alert('‚úÖ ¬°Notificaciones habilitadas!\n\nAhora recibir√°s alertas de tus recordatorios.');
                
                // Schedule all reminders
                reminders.forEach(reminder => {
                    if (!reminder.completed) {
                        scheduleNotification(reminder);
                    }
                });
                
                // Show test notification
                if (confirm('¬øQuieres ver una notificaci√≥n de prueba?')) {
                    new Notification('üéâ ¬°Notificaciones Activadas!', {
                        body: 'Las notificaciones de la app Horario ESFM est√°n funcionando correctamente.',
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23006847"/><text x="50" y="50" text-anchor="middle" dominant-baseline="middle" font-size="50" fill="white">üìÖ</text></svg>',
                        vibrate: [200, 100, 200]
                    });
                }
            } else {
                updateNotificationStatus();
                alert('‚ùå No se pudieron activar las notificaciones.\n\nRevisa los permisos de tu navegador.');
            }
        }

        function renderHolidaysList() {
            const list = document.getElementById('holidays-list');
            if (!academicConfig.holidays || academicConfig.holidays.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No hay feriados configurados</div>';
                return;
            }
            
            // Sort holidays by date
            const sorted = [...academicConfig.holidays].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            list.innerHTML = sorted.map((holiday, idx) => {
                const actualIdx = academicConfig.holidays.findIndex(h => h.date === holiday.date && h.name === holiday.name);
                const date = new Date(holiday.date);
                const dateStr = date.toLocaleDateString('es-BO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                return `
                    <div style="background: #FFF3E0; border-left: 4px solid #FF9800; padding: 12px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 3px;">üéâ ${holiday.name}</div>
                            <div style="font-size: 12px; color: #666;">üìÖ ${dateStr}</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="editHoliday(${actualIdx})" style="padding: 6px 12px; background: #E3F2FD; border: none; border-radius: 5px; color: #1565C0; font-size: 12px; cursor: pointer; font-weight: 500;">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="deleteHoliday(${actualIdx})" style="padding: 6px 12px; background: #FFEBEE; border: none; border-radius: 5px; color: #C62828; font-size: 12px; cursor: pointer; font-weight: 500;">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addHoliday() {
            const date = document.getElementById('new-holiday-date').value;
            const name = document.getElementById('new-holiday-name').value.trim();
            
            if (!date) {
                alert('Por favor selecciona una fecha');
                return;
            }
            
            if (!name) {
                alert('Por favor ingresa el nombre del feriado');
                return;
            }
            
            // Check if already exists
            if (academicConfig.holidays.some(h => h.date === date)) {
                alert('Ya existe un feriado en esta fecha');
                return;
            }
            
            academicConfig.holidays.push({ date, name });
            localStorage.setItem('academicConfig', JSON.stringify(academicConfig));
            
            document.getElementById('new-holiday-date').value = '';
            document.getElementById('new-holiday-name').value = '';
            
            renderHolidaysList();
            updateCalendar(); // Refresh calendar to show holiday
            
            alert('‚úÖ Feriado agregado');
        }

        function deleteHoliday(index) {
            const holiday = academicConfig.holidays[index];
            
            if (confirm(`¬øEliminar el feriado "${holiday.name}"?`)) {
                academicConfig.holidays.splice(index, 1);
                localStorage.setItem('academicConfig', JSON.stringify(academicConfig));
                renderHolidaysList();
                updateCalendar(); // Refresh calendar
                renderDayTabs(); // Refresh tabs
                alert('‚úÖ Feriado eliminado');
            }
        }

        function editHoliday(index) {
            const holiday = academicConfig.holidays[index];
            
            const newName = prompt(`Editar nombre del feriado:\n(Fecha: ${holiday.date})`, holiday.name);
            
            if (newName === null) return; // Cancelled
            
            if (!newName.trim()) {
                alert('El nombre no puede estar vac√≠o');
                return;
            }
            
            const newDate = prompt(`Editar fecha del feriado:\n(Formato: AAAA-MM-DD)`, holiday.date);
            
            if (newDate === null) return; // Cancelled
            
            // Validate date format
            if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
                alert('Formato de fecha inv√°lido. Usa: AAAA-MM-DD (ejemplo: 2026-12-25)');
                return;
            }
            
            // Check if new date conflicts with another holiday (unless it's the same holiday)
            const existingHoliday = academicConfig.holidays.find((h, i) => h.date === newDate && i !== index);
            if (existingHoliday) {
                alert(`Ya existe un feriado en esa fecha: ${existingHoliday.name}`);
                return;
            }
            
            // Update holiday
            academicConfig.holidays[index] = {
                date: newDate,
                name: newName.trim()
            };
            
            localStorage.setItem('academicConfig', JSON.stringify(academicConfig));
            renderHolidaysList();
            updateCalendar();
            renderDayTabs();
            alert('‚úÖ Feriado actualizado');
        }

        function toggleHolidayOnDate(dateStr) {
            const existing = academicConfig.holidays.findIndex(h => h.date === dateStr);
            
            if (existing >= 0) {
                // Remove holiday
                if (confirm(`¬øQuitar el feriado "${academicConfig.holidays[existing].name}"?`)) {
                    academicConfig.holidays.splice(existing, 1);
                    localStorage.setItem('academicConfig', JSON.stringify(academicConfig));
                    updateCalendar();
                }
            } else {
                // Add holiday
                const name = prompt('Nombre del feriado:');
                if (name && name.trim()) {
                    academicConfig.holidays.push({ date: dateStr, name: name.trim() });
                    localStorage.setItem('academicConfig', JSON.stringify(academicConfig));
                    updateCalendar();
                    alert('‚úÖ Feriado agregado');
                }
            }
        }

        // ============================================
        // MISSING FUNCTIONS - ADDED
        // ============================================

        function setTodayDate() {
            const today = new Date();
            const dayMap = { 1: 'lunes', 2: 'martes', 3: 'miercoles', 4: 'jueves', 5: 'viernes', 6: 'sabado', 0: 'domingo' };
            const todayDay = dayMap[today.getDay()];
            if (todayDay) {
                selectedDay = todayDay;
                renderDayTabs();
                renderSchedule();
            }
        }

        function clearForm() {
            const titleEl = document.getElementById('reminder-title');
            const descEl = document.getElementById('reminder-description');
            const dateEl = document.getElementById('reminder-date');
            const timeEl = document.getElementById('reminder-time');
            if (titleEl) titleEl.value = '';
            if (descEl) descEl.value = '';
            if (dateEl) dateEl.value = '';
            if (timeEl) timeEl.value = '';
        }

        async function saveReminder() {
            const type = document.getElementById('reminder-type').value;
            const subject = document.getElementById('reminder-subject').value;
            const title = document.getElementById('reminder-title').value.trim();
            const description = document.getElementById('reminder-description').value.trim();
            const date = document.getElementById('reminder-date').value;
            const time = document.getElementById('reminder-time').value;

            if (!title) {
                alert('Por favor ingresa un t√≠tulo');
                return;
            }
            if (!date) {
                alert('Por favor selecciona una fecha');
                return;
            }

            let reminder;
            try {
                reminder = {
                    id: Date.now(),
                    type,
                    subject,
                    title,
                    description,
                    date,
                    time,
                    completed: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Guardar en Firestore
                if (currentUser) {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('reminders')
                        .doc(String(reminder.id))
                        .set(reminder);
                } else {
                    alert('‚ùå No hay sesi√≥n activa. Inicia sesi√≥n para guardar recordatorios.');
                    return;
                }
            } catch (error) {
                console.error('Error al guardar recordatorio en Firestore:', error);
                alert('‚ùå Error al guardar recordatorio. Verifica tu conexi√≥n e intenta de nuevo.');
                return;
            }

            // Actualizar array local inmediatamente (UI responsiva sin esperar onSnapshot)
            const localReminder = { ...reminder, firestoreId: String(reminder.id) };
            delete localReminder.createdAt; // evitar el serverTimestamp sentinel no serializable
            reminders.unshift(localReminder);
            closeModal();
            if (currentView === 'recordatorios') renderReminders();
            if (currentView === 'calendario') updateCalendar();
            // onSnapshot reconciliar√° el array con los datos reales de Firestore

            // Sincronizar con Google Calendar / notificaciones (errores aqu√≠ no afectan el guardado)
            try {
                const notificationMethod = document.getElementById('notification-method')?.value || 'web';
                if (notificationMethod === 'calendar' || notificationMethod === 'both') {
                    if (!gapiInited || !gisInited) {
                        // Scripts a√∫n cargando ‚Äî intentar inicializar y reintentar una vez
                        initGoogleCalendar();
                        await new Promise(r => setTimeout(r, 2000));
                    }
                    if (gapiInited && gisInited) {
                        const calendarEventId = await addToGoogleCalendar(reminder);
                        if (calendarEventId && currentUser) {
                            await db.collection('users').doc(currentUser.uid)
                                .collection('reminders')
                                .doc(String(reminder.id))
                                .update({ calendarEventId });
                        }
                        if (calendarEventId) {
                            alert('‚úÖ Recordatorio guardado y agregado a Google Calendar.');
                        } else {
                            alert('‚úÖ Recordatorio guardado.\n‚ö†Ô∏è No se pudo sincronizar con Google Calendar. Revisa los permisos.');
                        }
                    } else {
                        alert('‚úÖ Recordatorio guardado.\n‚ö†Ô∏è Google Calendar no est√° listo. Recarga la p√°gina e intenta de nuevo.');
                    }
                } else {
                    if (time) {
                        await scheduleEnhancedNotification(reminder);
                    }
                    alert('‚úÖ Recordatorio guardado!');
                }
            } catch (notifError) {
                console.warn('‚ö†Ô∏è Recordatorio guardado, pero fall√≥ la notificaci√≥n:', notifError);
                alert('‚úÖ Recordatorio guardado.\n‚ö†Ô∏è No se pudo programar la notificaci√≥n push.');
            }
        }

        async function deleteReminder(idx) {
            if (confirm('¬øEliminar este recordatorio?')) {
                const reminder = reminders[idx];

                try {
                    // Si hay evento en Google Calendar, eliminarlo tambi√©n
                    if (reminder.calendarEventId && gapiInited && gisInited) {
                        await deleteFromGoogleCalendar(reminder.calendarEventId);
                    }

                    if (currentUser && reminder.firestoreId) {
                        await db.collection('users').doc(currentUser.uid)
                            .collection('reminders')
                            .doc(reminder.firestoreId)
                            .delete();
                    } else if (currentUser && reminder.id) {
                        await db.collection('users').doc(currentUser.uid)
                            .collection('reminders')
                            .doc(String(reminder.id))
                            .delete();
                    } else {
                        // Fallback a localStorage
                        reminders.splice(idx, 1);
                        localStorage.setItem('reminders', JSON.stringify(reminders));
                        renderReminders();
                        updateCalendar();
                    }
                    // UI se actualiza autom√°ticamente con el listener
                } catch (error) {
                    console.error('Error al eliminar recordatorio:', error);
                    alert('‚ùå Error al eliminar recordatorio');
                }
            }
        }

        function addQuickNote(day, idx) {
            const schedule = customSchedule || scheduleData;
            const cls = schedule[day][idx];
            const note = prompt(`üìù Nota r√°pida para ${cls.subject}:`);
            if (note && note.trim()) {
                const reminder = {
                    id: Date.now(),
                    type: 'tarea',
                    subject: cls.subject,
                    title: note.trim(),
                    description: '',
                    date: new Date().toISOString().split('T')[0],
                    time: '',
                    completed: false
                };
                reminders.push(reminder);
                localStorage.setItem('reminders', JSON.stringify(reminders));
                renderReminders();
                updateCalendar();
                alert('‚úÖ Nota guardada');
            }
        }

        function addReminderFor(subject, day) {
            openModal();
            setTimeout(() => {
                const subjectSelect = document.getElementById('reminder-subject');
                if (subjectSelect) {
                    for (let opt of subjectSelect.options) {
                        if (opt.value === subject) {
                            opt.selected = true;
                            break;
                        }
                    }
                }
            }, 100);
        }

        function addReminderFromClass() {
            if (!currentClassContext) return;
            closeClassModal();
            addReminderFor(currentClassContext.class.subject, currentClassContext.day);
        }

        function populateAttendanceSubjectFilter() {
            const picker = document.getElementById('attendance-subject-picker');
            if (picker) {
                picker.innerHTML = subjectsCatalog.map(subject =>
                    `<option value="${subject}" ${subject === currentAttendanceSubject ? 'selected' : ''}>${subject}</option>`
                ).join('');
            }
        }

        // Settings: Subjects management
        function renderSubjectsList() {
            const listHTML = subjectsCatalog.map((subject, idx) => `
                <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1; font-weight: 600; font-size: 13px;">${subject}</div>
                    <button onclick="deleteSubject(${idx})" style="padding: 6px 12px; background: #FFEBEE; border: none; border-radius: 5px; color: #C62828; font-size: 12px; cursor: pointer; font-weight: 500;">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
            
            document.getElementById('subjects-list').innerHTML = listHTML || '<div style="text-align: center; color: #999; padding: 20px;">No hay materias. Agrega la primera abajo.</div>';
        }

        function addSubject() {
            const name = document.getElementById('new-subject-name').value.trim();
            if (!name) {
                alert('Por favor ingresa el nombre de la materia');
                return;
            }
            if (subjectsCatalog.includes(name)) {
                alert('Esta materia ya existe');
                return;
            }
            subjectsCatalog.push(name);
            localStorage.setItem('subjectsCatalog', JSON.stringify(subjectsCatalog));
            document.getElementById('new-subject-name').value = '';
            renderSubjectsList();
            alert('‚úÖ Materia agregada');
        }

        function deleteSubject(idx) {
            const subject = subjectsCatalog[idx];
            if (confirm(`¬øEliminar "${subject}" del cat√°logo?`)) {
                subjectsCatalog.splice(idx, 1);
                localStorage.setItem('subjectsCatalog', JSON.stringify(subjectsCatalog));
                renderSubjectsList();
                alert('‚úÖ Materia eliminada');
            }
        }

        // Settings: Teachers management
        function renderTeachersList() {
            const listHTML = teachersCatalog.map((teacher, idx) => `
                <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1; font-weight: 600; font-size: 13px;">üë®‚Äçüè´ ${teacher}</div>
                    <button onclick="deleteTeacher(${idx})" style="padding: 6px 12px; background: #FFEBEE; border: none; border-radius: 5px; color: #C62828; font-size: 12px; cursor: pointer; font-weight: 500;">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
            
            document.getElementById('teachers-list').innerHTML = listHTML || '<div style="text-align: center; color: #999; padding: 20px;">No hay docentes. Agrega el primero abajo.</div>';
        }

        function addTeacher() {
            const name = document.getElementById('new-teacher-name').value.trim();
            if (!name) {
                alert('Por favor ingresa el nombre del docente');
                return;
            }
            if (teachersCatalog.includes(name)) {
                alert('Este docente ya existe');
                return;
            }
            teachersCatalog.push(name);
            localStorage.setItem('teachersCatalog', JSON.stringify(teachersCatalog));
            document.getElementById('new-teacher-name').value = '';
            renderTeachersList();
            alert('‚úÖ Docente agregado');
        }

        function deleteTeacher(idx) {
            const teacher = teachersCatalog[idx];
            if (confirm(`¬øEliminar "${teacher}" del cat√°logo?`)) {
                teachersCatalog.splice(idx, 1);
                localStorage.setItem('teachersCatalog', JSON.stringify(teachersCatalog));
                renderTeachersList();
                alert('‚úÖ Docente eliminado');
            }
        }

        // Settings: Schedule editing
        function loadDayForEditing() {
            const day = document.getElementById('settings-day-select').value;
            const schedule = customSchedule || scheduleData;
            const classes = schedule[day] || [];
            
            const container = document.getElementById('settings-classes-list');
            
            if (classes.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No hay clases para este d√≠a</div>';
                return;
            }
            
            container.innerHTML = classes.map((cls, idx) => `
                <div style="background: ${cls.isBreak ? '#FFF9E6' : 'white'}; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 3px;">${cls.subject}</div>
                            <div style="font-size: 12px; color: #666;">‚è∞ ${cls.time} | ${cls.period}</div>
                            ${cls.teacher ? `<div style="font-size: 12px; color: #666;">üë®‚Äçüè´ ${cls.teacher}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="editClass('${day}', ${idx})" style="padding: 6px 12px; background: #E3F2FD; border: none; border-radius: 5px; color: #1565C0; font-size: 12px; cursor: pointer; font-weight: 500;">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="deleteClass('${day}', ${idx})" style="padding: 6px 12px; background: #FFEBEE; border: none; border-radius: 5px; color: #C62828; font-size: 12px; cursor: pointer; font-weight: 500;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function populateSubjectSelect() {
            const select = document.getElementById('edit-subject');
            if (select) {
                select.innerHTML = subjectsCatalog.map(s => `<option value="${s}">${s}</option>`).join('');
            }
        }

        function populateTeacherSelect() {
            const select = document.getElementById('edit-teacher');
            if (select) {
                select.innerHTML = teachersCatalog.map(t => `<option value="${t}">${t}</option>`).join('');
            }
        }

        function editClass(day, idx) {
            editingDay = day;
            editingClassIndex = idx;
            
            const schedule = customSchedule || scheduleData;
            const cls = schedule[day][idx];
            
            document.getElementById('edit-day').value = day;
            
            populatePeriodSelect();
            populateTimeSlotSelect();
            populateSubjectSelect();
            populateTeacherSelect();
            
            document.getElementById('edit-period').value = cls.period;
            document.getElementById('edit-time-slot').value = cls.time;
            document.getElementById('edit-subject').value = cls.subject;
            document.getElementById('edit-teacher').value = cls.teacher;
            document.getElementById('edit-is-break').checked = cls.isBreak || false;
            
            document.getElementById('edit-class-modal').classList.add('active');
        }

        function closeEditClass() {
            document.getElementById('edit-class-modal').classList.remove('active');
            editingClassIndex = null;
            editingDay = null;
        }

        function saveEditedClass() {
            if (!customSchedule) {
                customSchedule = JSON.parse(JSON.stringify(scheduleData));
            }
            
            const day = document.getElementById('edit-day').value;
            const isBreak = document.getElementById('edit-is-break').checked;
            
            const classData = {
                time: document.getElementById('edit-time-slot').value,
                subject: isBreak ? 'RECREO' : document.getElementById('edit-subject').value,
                teacher: isBreak ? '' : document.getElementById('edit-teacher').value,
                period: document.getElementById('edit-period').value,
                isBreak: isBreak
            };
            
            if (editingClassIndex !== null && editingDay !== null) {
                // If the day changed, move the class
                if (editingDay !== day) {
                    customSchedule[editingDay].splice(editingClassIndex, 1);
                    if (!customSchedule[day]) customSchedule[day] = [];
                    customSchedule[day].push(classData);
                } else {
                    customSchedule[day][editingClassIndex] = classData;
                }
            }

            localStorage.setItem('customSchedule', JSON.stringify(customSchedule));
            saveScheduleToFirestore(); // Sincronizar con Firestore

            closeEditClass();
            loadDayForEditing();
            renderSchedule();
            renderDayTabs();
            
            alert('‚úÖ Clase actualizada');
        }

        function addNewClass() {
            const day = document.getElementById('settings-day-select').value;
            
            if (!customSchedule) {
                customSchedule = JSON.parse(JSON.stringify(scheduleData));
            }
            
            if (!customSchedule[day]) {
                customSchedule[day] = [];
            }
            
            editingDay = day;
            editingClassIndex = customSchedule[day].length;
            
            // Add a blank class
            customSchedule[day].push({
                time: timeSlotsCatalog[0] || '8:00 - 9:00',
                subject: subjectsCatalog[0] || 'Nueva Materia',
                teacher: teachersCatalog[0] || 'Docente',
                period: periodsCatalog[0] || '1er periodo',
                isBreak: false
            });

            localStorage.setItem('customSchedule', JSON.stringify(customSchedule));
            saveScheduleToFirestore(); // Sincronizar con Firestore

            // Open edit modal for the new class
            editClass(day, editingClassIndex);
            loadDayForEditing();
        }

        function deleteClass(day, idx) {
            if (!confirm('¬øEliminar esta clase?')) return;
            
            if (!customSchedule) {
                customSchedule = JSON.parse(JSON.stringify(scheduleData));
            }
            
            customSchedule[day].splice(idx, 1);
            localStorage.setItem('customSchedule', JSON.stringify(customSchedule));
            saveScheduleToFirestore(); // Sincronizar con Firestore

            loadDayForEditing();
            renderSchedule();
            
            alert('‚úÖ Clase eliminada');
        }

        function resetSchedule() {
            if (confirm('‚ö†Ô∏è ¬øRestaurar el horario original?\n\nEsto eliminar√° todos los cambios que hayas hecho al horario.')) {
                customSchedule = null;
                localStorage.removeItem('customSchedule');
                loadDayForEditing();
                renderSchedule();
                renderDayTabs();
                alert('‚úÖ Horario restaurado al original');
            }
        }

        function toggleBreakFields() {
            const isBreak = document.getElementById('edit-is-break').checked;
            const subjectSelect = document.getElementById('edit-subject');
            const teacherSelect = document.getElementById('edit-teacher');
            if (subjectSelect) subjectSelect.disabled = isBreak;
            if (teacherSelect) teacherSelect.disabled = isBreak;
        }

        function openQuickAddSubject() {
            const name = prompt('Nombre de la nueva materia:');
            if (name && name.trim()) {
                if (subjectsCatalog.includes(name.trim())) {
                    alert('Esta materia ya existe');
                    return;
                }
                subjectsCatalog.push(name.trim());
                localStorage.setItem('subjectsCatalog', JSON.stringify(subjectsCatalog));
                populateSubjectSelect();
                document.getElementById('edit-subject').value = name.trim();
                alert('‚úÖ Materia agregada');
            }
        }

        function openQuickAddTeacher() {
            const name = prompt('Nombre del nuevo docente:');
            if (name && name.trim()) {
                if (teachersCatalog.includes(name.trim())) {
                    alert('Este docente ya existe');
                    return;
                }
                teachersCatalog.push(name.trim());
                localStorage.setItem('teachersCatalog', JSON.stringify(teachersCatalog));
                populateTeacherSelect();
                document.getElementById('edit-teacher').value = name.trim();
                alert('‚úÖ Docente agregado');
            }
        }

        function openQuickAddTimeSlot() {
            const start = prompt('Hora de inicio (HH:MM):');
            const end = prompt('Hora de fin (HH:MM):');
            if (start && end) {
                const slot = `${start.trim()} - ${end.trim()}`;
                if (timeSlotsCatalog.includes(slot)) {
                    alert('Este horario ya existe');
                    return;
                }
                timeSlotsCatalog.push(slot);
                localStorage.setItem('timeSlotsCatalog', JSON.stringify(timeSlotsCatalog));
                populateTimeSlotSelect();
                document.getElementById('edit-time-slot').value = slot;
                alert('‚úÖ Horario agregado');
            }
        }

        // Grades / Evaluation functions
        function openGradesView() {
            document.getElementById('grades-modal').classList.add('active');
            const select = document.getElementById('grades-subject-filter');
            select.innerHTML = subjectsCatalog.map(s => `<option value="${s}">${s}</option>`).join('');
            updateGradesView();
        }

        function closeGradesView() {
            document.getElementById('grades-modal').classList.remove('active');
        }

        function updateGradesView() {
            const subject = document.getElementById('grades-subject-filter').value;
            
            // Render criteria summary
            const criteriaSummary = document.getElementById('criteria-summary');
            const totalPct = evaluationCriteria.reduce((sum, c) => sum + c.percentage, 0);
            criteriaSummary.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">üìä Criterios de Evaluaci√≥n (${totalPct}%)</div>
                ${evaluationCriteria.map(c => `
                    <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 3px;">
                        <span>${c.name}</span>
                        <span style="font-weight: 600;">${c.percentage}% (m√°x: ${c.maxScore})</span>
                    </div>
                `).join('')}
            `;
            
            // Render grades table
            const container = document.getElementById('grades-table-container');
            
            if (studentsList.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No hay estudiantes registrados</div>';
                return;
            }
            
            let tableHTML = `<table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Estudiante</th>
                        ${evaluationCriteria.map(c => `<th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">${c.name}<br><span style="font-size: 10px; color: #999;">(${c.percentage}%)</span></th>`).join('')}
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd; background: #E8F5E9;">Final</th>
                    </tr>
                </thead>
                <tbody>`;
            
            studentsList.forEach(student => {
                const key = `${subject}|${student}`;
                const grades = studentGrades[key] || {};
                
                let finalScore = 0;
                
                tableHTML += `<tr>
                    <td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: 500;">${student}</td>`;
                
                evaluationCriteria.forEach(c => {
                    const grade = grades[c.id] || '';
                    const numGrade = parseFloat(grade) || 0;
                    finalScore += (numGrade / c.maxScore) * c.percentage;
                    
                    tableHTML += `<td style="padding: 5px; text-align: center; border-bottom: 1px solid #eee;">
                        <input type="number" value="${grade}" min="0" max="${c.maxScore}" 
                               onchange="updateGrade('${subject.replace(/'/g, "\\'")}', '${student.replace(/'/g, "\\'")}', '${c.id}', this.value)"
                               style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; text-align: center; font-size: 13px;">
                    </td>`;
                });
                
                tableHTML += `<td style="padding: 10px; text-align: center; border-bottom: 1px solid #eee; font-weight: 700; background: #E8F5E9; color: ${finalScore >= 51 ? '#2E7D32' : '#C62828'};">
                    ${finalScore.toFixed(1)}
                </td></tr>`;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function updateGrade(subject, student, criteriaId, value) {
            const key = `${subject}|${student}`;
            if (!studentGrades[key]) {
                studentGrades[key] = {};
            }
            studentGrades[key][criteriaId] = value;
            localStorage.setItem('studentGrades', JSON.stringify(studentGrades));
            updateGradesView();
        }

        function openCriteriaSettings() {
            document.getElementById('criteria-settings-modal').classList.add('active');
            renderCriteriaList();
        }

        function closeCriteriaSettings() {
            document.getElementById('criteria-settings-modal').classList.remove('active');
            updateGradesView();
        }

        function renderCriteriaList() {
            const container = document.getElementById('criteria-list');
            const totalPct = evaluationCriteria.reduce((sum, c) => sum + c.percentage, 0);
            
            container.innerHTML = evaluationCriteria.map((c, idx) => `
                <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600;">${c.name}</div>
                        <div style="font-size: 12px; color: #666;">${c.percentage}% | M√°x: ${c.maxScore}</div>
                    </div>
                    <button onclick="deleteCriteria(${idx})" style="padding: 6px 12px; background: #FFEBEE; border: none; border-radius: 5px; color: #C62828; font-size: 12px; cursor: pointer;">üóëÔ∏è</button>
                </div>
            `).join('');
            
            document.getElementById('total-percentage').innerHTML = `Total: ${totalPct}% ${totalPct === 100 ? '‚úÖ' : '‚ö†Ô∏è Debe sumar 100%'}`;
            document.getElementById('total-percentage').style.background = totalPct === 100 ? '#E8F5E9' : '#FFF3E0';
            document.getElementById('total-percentage').style.color = totalPct === 100 ? '#2E7D32' : '#E65100';
        }

        function addCriteria() {
            const name = document.getElementById('new-criteria-name').value.trim();
            const percentage = parseInt(document.getElementById('new-criteria-percentage').value);
            const maxScore = parseInt(document.getElementById('new-criteria-max').value) || 100;
            
            if (!name) {
                alert('Por favor ingresa el nombre del criterio');
                return;
            }
            if (!percentage || percentage <= 0) {
                alert('Por favor ingresa un porcentaje v√°lido');
                return;
            }
            
            const id = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            
            evaluationCriteria.push({ id, name, percentage, maxScore });
            localStorage.setItem('evaluationCriteria', JSON.stringify(evaluationCriteria));
            
            document.getElementById('new-criteria-name').value = '';
            document.getElementById('new-criteria-percentage').value = '';
            
            renderCriteriaList();
            alert('‚úÖ Criterio agregado');
        }

        function deleteCriteria(idx) {
            if (confirm('¬øEliminar este criterio?')) {
                evaluationCriteria.splice(idx, 1);
                localStorage.setItem('evaluationCriteria', JSON.stringify(evaluationCriteria));
                renderCriteriaList();
            }
        }

        function exportGradesToExcel() {
            if (typeof XLSX === 'undefined') {
                alert('‚ùå La librer√≠a de Excel no est√° cargada. Verifica tu conexi√≥n a internet.');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            subjectsCatalog.forEach(subject => {
                const sheetData = [
                    ['Estudiante', ...evaluationCriteria.map(c => `${c.name} (${c.percentage}%)`), 'Nota Final']
                ];
                
                studentsList.forEach(student => {
                    const key = `${subject}|${student}`;
                    const grades = studentGrades[key] || {};
                    const row = [student];
                    let finalScore = 0;
                    
                    evaluationCriteria.forEach(c => {
                        const grade = parseFloat(grades[c.id]) || 0;
                        finalScore += (grade / c.maxScore) * c.percentage;
                        row.push(grade);
                    });
                    
                    row.push(parseFloat(finalScore.toFixed(1)));
                    sheetData.push(row);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(sheetData);
                XLSX.utils.book_append_sheet(wb, ws, subject.substring(0, 30));
            });
            
            XLSX.writeFile(wb, 'Calificaciones_' + new Date().toISOString().split('T')[0] + '.xlsx');
            alert('‚úÖ Calificaciones exportadas a Excel');
        }

        // BACKUP AND RESTORE FUNCTIONS
        
        function exportBackup() {
            const backup = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                appName: 'Horario ESFM Sim√≥n Bol√≠var',
                data: {
                    customSchedule: localStorage.getItem('customSchedule'),
                    reminders: localStorage.getItem('reminders'),
                    attendanceRecords: localStorage.getItem('attendanceRecords'),
                    studentsList: localStorage.getItem('studentsList'),
                    customCategories: localStorage.getItem('customCategories'),
                    academicConfig: localStorage.getItem('academicConfig'),
                    subjectsCatalog: localStorage.getItem('subjectsCatalog'),
                    teachersCatalog: localStorage.getItem('teachersCatalog'),
                    periodsCatalog: localStorage.getItem('periodsCatalog'),
                    timeSlotsCatalog: localStorage.getItem('timeSlotsCatalog'),
                    studentGrades: localStorage.getItem('studentGrades')
                }
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `horario-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Backup exportado correctamente\n\nüìÅ Archivo: horario-backup-' + new Date().toISOString().split('T')[0] + '.json');
        }

        function openImportBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    importBackup(file);
                }
            };
            input.click();
        }

        function importBackup(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.version || !backup.data) {
                        throw new Error('Archivo de backup inv√°lido');
                    }
                    
                    const confirmMsg = `‚ö†Ô∏è ADVERTENCIA ‚ö†Ô∏è\n\n` +
                        `Esto reemplazar√° TODOS tus datos actuales con:\n\n` +
                        `üìÖ Backup creado: ${new Date(backup.exportDate).toLocaleString('es-BO')}\n` +
                        `üì± App: ${backup.appName || 'Horario ESFM'}\n\n` +
                        `¬øEst√°s seguro de continuar?`;
                    
                    if (confirm(confirmMsg)) {
                        // Import all data
                        Object.keys(backup.data).forEach(key => {
                            if (backup.data[key]) {
                                localStorage.setItem(key, backup.data[key]);
                            }
                        });
                        
                        alert('‚úÖ Backup restaurado correctamente\n\nLa app se recargar√° ahora.');
                        setTimeout(() => location.reload(), 1000);
                    }
                } catch (error) {
                    alert('‚ùå Error al importar backup:\n\n' + error.message + '\n\nAseg√∫rate de que el archivo sea un backup v√°lido.');
                }
            };
            reader.readAsText(file);
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Export attendance for each subject
            subjectsCatalog.forEach(subject => {
                const records = attendanceRecords.filter(r => r.subject === subject);
                
                if (records.length === 0) return;
                
                // Group by date
                const byDate = {};
                records.forEach(r => {
                    if (!byDate[r.date]) byDate[r.date] = {};
                    byDate[r.date][r.student] = {
                        status: r.status,
                        notes: r.notes || ''
                    };
                });
                
                const dates = Object.keys(byDate).sort();
                
                // Create sheet data
                const sheetData = [
                    ['Estudiante', ...dates.map(d => new Date(d).toLocaleDateString('es-BO'))],
                ];
                
                studentsList.forEach(student => {
                    const row = [student];
                    dates.forEach(date => {
                        const att = byDate[date][student];
                        if (att) {
                            row.push(`${getStatusText(att.status)}${att.notes ? ' - ' + att.notes : ''}`);
                        } else {
                            row.push('');
                        }
                    });
                    sheetData.push(row);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(sheetData);
                XLSX.utils.book_append_sheet(wb, ws, subject.substring(0, 30));
            });
            
            XLSX.writeFile(wb, 'Asistencia_' + new Date().toISOString().split('T')[0] + '.xlsx');
            alert('‚úÖ Excel exportado correctamente');
        }

        // Initialize everything
        loadTheme(); // Load theme first
        setTodayDate(); // Set today as selected day
        updateWeekDisplay(); // Show week range
        renderDayTabs(); // Render day tabs with dates
        renderSchedule();
        initNavigation();
        updateCalendar();
        renderReminders();
        populateCategorySelect();

        // Install button for PWA
        let deferredPrompt;
        const installButton = document.createElement('button');
        installButton.textContent = '‚¨áÔ∏è Instalar App';
        installButton.style.cssText = 'position: fixed; bottom: 80px; right: 20px; background: #006847; color: white; border: none; padding: 15px 20px; border-radius: 50px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer; font-weight: 600; z-index: 1000; display: none;';
        document.body.appendChild(installButton);

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';
        });

        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                console.log('App instalada');
            }
            deferredPrompt = null;
            installButton.style.display = 'none';
        });

        window.addEventListener('appinstalled', () => {
            installButton.style.display = 'none';
            alert('‚úÖ ¬°App instalada correctamente!');
        });

        if (window.matchMedia('(display-mode: standalone)').matches) {
            installButton.style.display = 'none';
        }

        // Generate and inject manifest
        const manifest = {
            name: "Horario ESFM Sim√≥n Bol√≠var",
            short_name: "Horario ESFM",
            description: "Aplicaci√≥n de horario escolar",
            start_url: window.location.pathname,
            display: "standalone",
            background_color: "#006847",
            theme_color: "#006847",
            orientation: "portrait",
            icons: [
                {
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' rx='40' fill='%23006847'/><text x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-size='100' fill='white'>üìÖ</text></svg>",
                    sizes: "192x192",
                    type: "image/svg+xml"
                },
                {
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='100' fill='%23006847'/><text x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-size='300' fill='white'>üìÖ</text></svg>",
                    sizes: "512x512",
                    type: "image/svg+xml"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = manifest;
        document.head.appendChild(manifestLink);

        // Service Worker
// Registrar Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
    .then(reg => console.log('‚úÖ Service Worker registrado'))
    .catch(err => console.log('‚ùå Error Service Worker:', err));

// Escuchar mensajes del Service Worker para completar recordatorios
    navigator.serviceWorker.addEventListener('message', function(event) {
        if (event.data.type === 'COMPLETE_REMINDER') {
            const reminderId = event.data.reminderId;
            const index = reminders.findIndex(r => r.id === reminderId);
            if (index !== -1) {
                reminders[index].completed = true;
                localStorage.setItem('reminders', JSON.stringify(reminders));
                renderReminders();
                updateCalendar();
            }
        }
    });
}
// Mostrar notificaci√≥n usando SW
async function showNotification(reminder, customTitle = null) {
    if (Notification.permission !== 'granted') return;

    const category = getCategoryById(reminder.type);
    const title = customTitle || `${category.icon} ${category.name}`;
    const body = `${reminder.title}\n${reminder.subject ? 'üìö ' + reminder.subject : ''}\n${reminder.description || ''}`;

    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        const registration = await navigator.serviceWorker.ready;
        registration.showNotification(title, {
            body,
            icon: 'data:image/svg+xml,<svg ...></svg>',
            badge: 'data:image/svg+xml,<svg ...></svg>',
            tag: `reminder-${reminder.id}`,
            requireInteraction: true,
            vibrate: [200, 100, 200],
            data: { reminderId: reminder.id },
        });
    } else {
        // Fallback si la p√°gina est√° abierta
        new Notification(title, { body });
    }
}
// scheduleNotification: alias legacy ‚Äî la implementaci√≥n real es scheduleWebNotification
// (definida m√°s abajo en el segundo bloque de script con soporte de Map para deduplicaci√≥n)
function scheduleNotification(reminder) {
    if (typeof scheduleWebNotification === 'function') {
        scheduleWebNotification(reminder);
    }
}

// Manejar par√°metro de URL para completar recordatorio
window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const completeId = urlParams.get('complete');
    if (completeId) {
        const index = reminders.findIndex(r => r.id === parseInt(completeId));
        if (index !== -1) {
            reminders[index].completed = true;
            localStorage.setItem('reminders', JSON.stringify(reminders));
            renderReminders();
            updateCalendar();
            // Limpiar URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }
});
    </script>
<script>
// ============================================
// FIREBASE PUSH NOTIFICATIONS
// ============================================

const firebaseConfig = {
    apiKey: "AIzaSyCEG3GL0YwSvc-KTQE_RZ4AgGELFc-yUME",
    authDomain: "horario-esfm.firebaseapp.com",
    projectId: "horario-esfm",
    storageBucket: "horario-esfm.firebasestorage.app",
    messagingSenderId: "1046696947499",
    appId: "1:1046696947499:web:8d593fcab4ef61379a9f6e",
    measurementId: "G-NNKXJN5YDR"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const messaging = firebase.messaging();

console.log('üî• Firebase inicializado correctamente');
console.log('üìß Auth disponible:', !!auth);
console.log('üíæ Firestore disponible:', !!db);

// Habilitar persistencia offline de Firestore
db.enablePersistence({ synchronizeTabs: true })
    .catch((err) => {
        if (err.code == 'failed-precondition') {
            console.warn('Persistencia: M√∫ltiples pesta√±as abiertas');
        } else if (err.code == 'unimplemented') {
            console.warn('Persistencia: No soportada en este navegador');
        }
    });

// Variables globales de usuario
let currentUser = null;
let userDataUnsubscribers = [];

// Clave VAPID
const VAPID_KEY = 'BBHwc5Mppt2z98YM4uazXcDnI6luBVutOdbmcBdIg9fqGxR9avIEDeONgnq9U33vK5wbE3LpJ1LFXtAhov9qMfY';

// Google Calendar API Config (constantes definidas en <head> para evitar conflicto de timing)

// Solicitar permiso y obtener token FCM, guardarlo en Firestore para push en background
async function initFirebasePush() {
    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            const token = await messaging.getToken({ vapidKey: VAPID_KEY });
            if (!token) return null;
            console.log('üì± Token FCM obtenido');
            localStorage.setItem('fcmToken', token);

            // Guardar token en Firestore para que el servidor pueda enviar notificaciones
            if (currentUser) {
                await db.collection('users').doc(currentUser.uid).set(
                    { fcmToken: token, fcmTokenUpdatedAt: firebase.firestore.FieldValue.serverTimestamp() },
                    { merge: true }
                );
                console.log('‚úÖ Token FCM guardado en Firestore');
            }
            return token;
        }
    } catch (error) {
        console.error('Error FCM:', error);
    }
    return null;
}

// Recibir mensajes cuando la app est√° ABIERTA
messaging.onMessage((payload) => {
    console.log('üì© Mensaje recibido:', payload);
    if (!payload.notification) return;
    const { title, body } = payload.notification;
    new Notification(title, {
        body: body,
        icon: 'icon-192.png'
    });
});

// ==============================================
// FUNCIONES HELPER PARA FECHAS (ARREGLA BUG DE ZONA HORARIA)
// ==============================================

/**
 * Parsea una fecha en formato YYYY-MM-DD sin problemas de zona horaria
 */
function parseLocalDate(dateStr) {
    if (!dateStr) return null;
    const [year, month, day] = dateStr.split('-').map(Number);
    return new Date(year, month - 1, day);
}

/**
 * Convierte una fecha a formato YYYY-MM-DD local
 */
function formatLocalDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// ==============================================
// SISTEMA DE AUTENTICACI√ìN
// ==============================================

// Observer de autenticaci√≥n
auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUser = user;
        console.log('‚úÖ Usuario autenticado:', user.email);

        // Mostrar app principal
        const authScreenEl = document.getElementById('auth-screen');
        const mainAppEl = document.getElementById('main-app');
        if (authScreenEl) authScreenEl.style.display = 'none';
        if (mainAppEl) mainAppEl.style.display = 'block';

        // Actualizar header con nombre de usuario
        const subtitle = document.querySelector('.header .subtitle');
        if (subtitle) {
            subtitle.textContent = `üë§ ${user.displayName || user.email}`;
        }

        // Actualizar email en configuraci√≥n
        const userEmailEl = document.getElementById('user-email');
        if (userEmailEl) {
            userEmailEl.textContent = user.email;
        }

        // Cargar m√©todo de notificaciones preferido
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            const notificationMethod = userData.notificationMethod || 'web';
            const methodSelect = document.getElementById('notification-method');
            if (methodSelect) {
                methodSelect.value = notificationMethod;
            }
        }

        // Verificar si necesita migraci√≥n desde localStorage
        await checkAndMigrateData(user.uid);

        // Iniciar listeners de sincronizaci√≥n en tiempo real
        setupRealtimeListeners(user.uid);

        // Registrar token FCM para notificaciones en segundo plano
        initFirebasePush();

    } else {
        currentUser = null;
        console.log('‚ùå Usuario no autenticado');

        // Limpiar listeners
        userDataUnsubscribers.forEach(unsub => unsub());
        userDataUnsubscribers = [];

        // Mostrar pantalla de login
        const authScreenLogout = document.getElementById('auth-screen');
        const mainAppLogout = document.getElementById('main-app');
        if (authScreenLogout) authScreenLogout.style.display = 'flex';
        if (mainAppLogout) mainAppLogout.style.display = 'none';
    }
});

// Cambiar tabs de login/registro
function switchAuthTab(tab) {
    const loginTab = document.getElementById('tab-login');
    const registerTab = document.getElementById('tab-register');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');

    if (tab === 'login') {
        loginTab.style.color = 'var(--primary)';
        loginTab.style.borderBottom = '3px solid var(--primary)';
        registerTab.style.color = '#999';
        registerTab.style.borderBottom = 'none';
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
    } else {
        registerTab.style.color = 'var(--primary)';
        registerTab.style.borderBottom = '3px solid var(--primary)';
        loginTab.style.color = '#999';
        loginTab.style.borderBottom = 'none';
        registerForm.style.display = 'block';
        loginForm.style.display = 'none';
    }

    hideAuthError();
}

// Login con email/password
async function loginWithEmail() {
    console.log('üîê Intentando login...');
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;

    console.log('üìß Email:', email);
    console.log('üîë Password length:', password.length);

    if (!email || !password) {
        showAuthError('Por favor completa todos los campos');
        return;
    }

    showAuthLoading(true);
    hideAuthError();

    try {
        console.log('‚è≥ Llamando a signInWithEmailAndPassword...');
        const result = await auth.signInWithEmailAndPassword(email, password);
        console.log('‚úÖ Login exitoso!', result.user.email);
        // El onAuthStateChanged se encargar√° del resto
    } catch (error) {
        console.error('‚ùå Error login completo:', error);
        console.error('‚ùå C√≥digo de error:', error.code);
        console.error('‚ùå Mensaje:', error.message);

        let message = 'Error al iniciar sesi√≥n: ' + (error.message || error.code);

        if (error.code === 'auth/user-not-found') {
            message = 'No existe una cuenta con este correo';
        } else if (error.code === 'auth/wrong-password') {
            message = 'Contrase√±a incorrecta';
        } else if (error.code === 'auth/invalid-email') {
            message = 'Correo electr√≥nico inv√°lido';
        } else if (error.code === 'auth/too-many-requests') {
            message = 'Demasiados intentos fallidos. Intenta m√°s tarde';
        }

        showAuthError(message);
    } finally {
        showAuthLoading(false);
    }
}

// Registro con email/password
async function registerWithEmail() {
    console.log('üìù Intentando registro...');
    const name = document.getElementById('register-name').value.trim();
    const email = document.getElementById('register-email').value.trim();
    const password = document.getElementById('register-password').value;
    const passwordConfirm = document.getElementById('register-password-confirm').value;

    console.log('üë§ Nombre:', name);
    console.log('üìß Email:', email);
    console.log('üîë Password length:', password.length);

    if (!name || !email || !password || !passwordConfirm) {
        showAuthError('Por favor completa todos los campos');
        return;
    }

    if (password.length < 6) {
        showAuthError('La contrase√±a debe tener al menos 6 caracteres');
        return;
    }

    if (password !== passwordConfirm) {
        showAuthError('Las contrase√±as no coinciden');
        return;
    }

    showAuthLoading(true);
    hideAuthError();

    try {
        console.log('‚è≥ Llamando a createUserWithEmailAndPassword...');
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        console.log('‚úÖ Usuario creado en Auth:', userCredential.user.uid);

        // Actualizar perfil con nombre
        console.log('‚è≥ Actualizando perfil con nombre...');
        await userCredential.user.updateProfile({
            displayName: name
        });
        console.log('‚úÖ Perfil actualizado');

        // Crear documento de perfil en Firestore
        console.log('‚è≥ Guardando datos en Firestore...');
        await db.collection('users').doc(userCredential.user.uid).set({
            name: name,
            email: email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            notificationMethod: 'web', // Default: Web notifications
            theme: 'light'
        });
        console.log('‚úÖ Datos guardados en Firestore');

        console.log('‚úÖ Usuario registrado completamente:', email);
        // El onAuthStateChanged se encargar√° del resto
    } catch (error) {
        console.error('‚ùå Error registro completo:', error);
        console.error('‚ùå C√≥digo de error:', error.code);
        console.error('‚ùå Mensaje:', error.message);

        let message = 'Error al crear la cuenta: ' + (error.message || error.code);

        if (error.code === 'auth/email-already-in-use') {
            message = 'Ya existe una cuenta con este correo';
        } else if (error.code === 'auth/invalid-email') {
            message = 'Correo electr√≥nico inv√°lido';
        } else if (error.code === 'auth/weak-password') {
            message = 'La contrase√±a es muy d√©bil';
        } else if (error.code === 'permission-denied' || error.code === 'firestore/permission-denied') {
            message = 'Error de permisos en base de datos. Contacta al administrador.';
        } else if (error.code) {
            message = 'Error al crear la cuenta (' + error.code + ')';
        }

        showAuthError(message);
    } finally {
        showAuthLoading(false);
    }
}

// Login con Google
async function loginWithGoogle() {
    showAuthLoading(true);
    hideAuthError();

    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({
            prompt: 'select_account'
        });

        const result = await auth.signInWithPopup(provider);

        // Crear/actualizar perfil en Firestore
        const userDoc = await db.collection('users').doc(result.user.uid).get();

        if (!userDoc.exists) {
            await db.collection('users').doc(result.user.uid).set({
                name: result.user.displayName,
                email: result.user.email,
                photoURL: result.user.photoURL,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                notificationMethod: 'web',
                theme: 'light'
            });
        }

        console.log('‚úÖ Login con Google exitoso');
        // El onAuthStateChanged se encargar√° del resto
    } catch (error) {
        console.error('Error Google login:', error);

        if (error.code !== 'auth/popup-closed-by-user') {
            showAuthError('Error al iniciar sesi√≥n con Google');
        }
    } finally {
        showAuthLoading(false);
    }
}

// Cerrar sesi√≥n
async function logout() {
    if (confirm('¬øEst√°s seguro que quieres cerrar sesi√≥n?')) {
        try {
            await auth.signOut();
            console.log('‚úÖ Sesi√≥n cerrada');
        } catch (error) {
            console.error('Error al cerrar sesi√≥n:', error);
            alert('Error al cerrar sesi√≥n');
        }
    }
}

// Helpers UI
function showAuthError(message) {
    const errorEl = document.getElementById('auth-error');
    errorEl.textContent = message;
    errorEl.style.display = 'block';
}

function hideAuthError() {
    const errorEl = document.getElementById('auth-error');
    errorEl.style.display = 'none';
}

function showAuthLoading(show) {
    document.getElementById('auth-loading').style.display = show ? 'block' : 'none';
}

// ==============================================
// MIGRACI√ìN DE DATOS LOCALSTORAGE ‚Üí FIRESTORE
// ==============================================

async function checkAndMigrateData(userId) {
    try {
        // Verificar si ya migr√≥ antes
        const migrated = localStorage.getItem('migrated_to_firebase');

        if (migrated) {
            console.log('‚úÖ Datos ya migrados previamente');
            return;
        }

        // Verificar si hay datos en localStorage
        const hasLocalData = localStorage.getItem('reminders') ||
                            localStorage.getItem('customSchedule') ||
                            localStorage.getItem('attendanceRecords');

        if (!hasLocalData) {
            console.log('‚ÑπÔ∏è No hay datos locales para migrar');
            localStorage.setItem('migrated_to_firebase', 'true');
            return;
        }

        // Confirmar migraci√≥n
        if (!confirm('üîÑ Detectamos datos guardados en este dispositivo.\n\n¬øQuieres sincronizarlos con tu cuenta en la nube?\n\nEsto te permitir√° acceder a tus datos desde cualquier dispositivo.')) {
            localStorage.setItem('migrated_to_firebase', 'true');
            return;
        }

        console.log('üîÑ Iniciando migraci√≥n de datos...');

        const batch = db.batch();
        const userRef = db.collection('users').doc(userId);

        // Migrar recordatorios
        const remindersData = localStorage.getItem('reminders');
        if (remindersData) {
            const reminders = JSON.parse(remindersData);
            reminders.forEach(reminder => {
                const reminderRef = userRef.collection('reminders').doc(String(reminder.id));
                batch.set(reminderRef, reminder);
            });
            console.log(`üìù Migrando ${reminders.length} recordatorios`);
        }

        // Migrar horario personalizado
        const scheduleData = localStorage.getItem('customSchedule');
        if (scheduleData) {
            batch.set(userRef.collection('settings').doc('customSchedule'), {
                data: JSON.parse(scheduleData),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log('üìÖ Migrando horario personalizado');
        }

        // Migrar asistencias
        const attendanceData = localStorage.getItem('attendanceRecords');
        if (attendanceData) {
            const records = JSON.parse(attendanceData);
            records.forEach((record, index) => {
                const recordRef = userRef.collection('attendance').doc(String(index));
                batch.set(recordRef, record);
            });
            console.log(`‚úÖ Migrando ${records.length} registros de asistencia`);
        }

        // Migrar lista de estudiantes
        const studentsData = localStorage.getItem('studentsList');
        if (studentsData) {
            batch.set(userRef.collection('settings').doc('studentsList'), {
                data: JSON.parse(studentsData),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Migrar categor√≠as personalizadas
        const categoriesData = localStorage.getItem('customCategories');
        if (categoriesData) {
            batch.set(userRef.collection('settings').doc('customCategories'), {
                data: JSON.parse(categoriesData),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Migrar configuraci√≥n acad√©mica
        const academicConfigData = localStorage.getItem('academicConfig');
        if (academicConfigData) {
            batch.set(userRef.collection('settings').doc('academicConfig'), {
                data: JSON.parse(academicConfigData),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Migrar cat√°logos
        const catalogsToMigrate = [
            'subjectsCatalog',
            'teachersCatalog',
            'periodsCatalog',
            'timeSlotsCatalog',
            'evaluationCriteria',
            'studentGrades'
        ];

        catalogsToMigrate.forEach(catalog => {
            const data = localStorage.getItem(catalog);
            if (data) {
                batch.set(userRef.collection('settings').doc(catalog), {
                    data: JSON.parse(data),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });

        // Ejecutar migraci√≥n
        await batch.commit();

        // Marcar como migrado
        localStorage.setItem('migrated_to_firebase', 'true');

        console.log('‚úÖ Migraci√≥n completada exitosamente');
        alert('‚úÖ Tus datos se sincronizaron correctamente con la nube!\n\nAhora puedes acceder a ellos desde cualquier dispositivo.');

    } catch (error) {
        console.error('‚ùå Error en migraci√≥n:', error);
        alert('‚ö†Ô∏è Hubo un problema al sincronizar tus datos. Tus datos locales no se perder√°n.');
    }
}

// ==============================================
// SINCRONIZACI√ìN EN TIEMPO REAL CON FIRESTORE
// ==============================================

function setupRealtimeListeners(userId) {
    const userRef = db.collection('users').doc(userId);

    // Listener para recordatorios
    const remindersUnsub = userRef.collection('reminders')
        .onSnapshot((snapshot) => {
            reminders = [];
            snapshot.forEach(doc => {
                reminders.push({ ...doc.data(), firestoreId: doc.id });
            });

            // Actualizar UI
            if (currentView === 'recordatorios') {
                renderReminders();
            }
            if (currentView === 'calendario') {
                updateCalendar();
            }

            // Reprogramar notificaciones para todos los recordatorios futuros no completados
            const now = new Date();
            reminders.forEach(reminder => {
                if (!reminder.completed && reminder.date && reminder.time) {
                    const reminderDate = parseLocalDate(reminder.date);
                    const [h, m] = reminder.time.split(':').map(Number);
                    reminderDate.setHours(h, m, 0, 0);
                    if (reminderDate > now) {
                        scheduleWebNotification(reminder);
                    }
                }
            });

            console.log(`üîÑ Recordatorios sincronizados: ${reminders.length}`);
        }, (error) => {
            console.error('Error listener recordatorios:', error);
        });

    userDataUnsubscribers.push(remindersUnsub);

    // Listener para horario personalizado
    const scheduleUnsub = userRef.collection('settings').doc('customSchedule')
        .onSnapshot((doc) => {
            if (doc.exists && doc.data().data) {
                customSchedule = doc.data().data;
                if (currentView === 'horario') {
                    renderSchedule();
                }
                console.log('üîÑ Horario sincronizado');
            }
        }, (error) => {
            console.error('Error listener horario:', error);
        });

    userDataUnsubscribers.push(scheduleUnsub);

    // Listener para asistencias
    const attendanceUnsub = userRef.collection('attendance')
        .onSnapshot((snapshot) => {
            attendanceRecords = [];
            snapshot.forEach(doc => {
                attendanceRecords.push({ ...doc.data(), firestoreId: doc.id });
            });

            if (currentView === 'asistencia') {
                loadAttendanceData();
            }

            console.log(`üîÑ Asistencias sincronizadas: ${attendanceRecords.length}`);
        }, (error) => {
            console.error('Error listener asistencias:', error);
        });

    userDataUnsubscribers.push(attendanceUnsub);

    // Listeners para configuraciones
    const settingsKeys = [
        'customCategories',
        'academicConfig',
        'subjectsCatalog',
        'teachersCatalog',
        'periodsCatalog',
        'timeSlotsCatalog',
        'studentsList',
        'evaluationCriteria',
        'studentGrades'
    ];

    settingsKeys.forEach(key => {
        const unsub = userRef.collection('settings').doc(key)
            .onSnapshot((doc) => {
                if (doc.exists && doc.data().data) {
                    // Actualizar variable global correspondiente
                    window[key] = doc.data().data;
                    console.log(`üîÑ ${key} sincronizado`);
                }
            }, (error) => {
                console.error(`Error listener ${key}:`, error);
            });

        userDataUnsubscribers.push(unsub);
    });
}

// ==============================================
// GESTI√ìN DE M√âTODO DE NOTIFICACIONES
// ==============================================

async function saveNotificationMethod() {
    if (!currentUser) return;

    const method = document.getElementById('notification-method').value;

    try {
        await db.collection('users').doc(currentUser.uid).update({
            notificationMethod: method
        });

        console.log('‚úÖ M√©todo de notificaciones actualizado:', method);

        // Mostrar mensaje seg√∫n el m√©todo
        let message = '';
        if (method === 'calendar') {
            message = '‚úÖ Tus recordatorios se sincronizar√°n con Google Calendar.\n\nLa pr√≥xima vez que agregues un recordatorio, se crear√° autom√°ticamente en tu calendario.';
        } else if (method === 'web') {
            message = '‚úÖ Usar√°s notificaciones web de la aplicaci√≥n.\n\nAseg√∫rate de habilitar los permisos de notificaci√≥n.';
        } else if (method === 'both') {
            message = '‚úÖ Usar√°s ambos m√©todos: Google Calendar + Notificaciones Web.\n\nTus recordatorios estar√°n en tu calendario Y recibir√°s notificaciones en la app.';
        }

        if (message) {
            alert(message);
        }

    } catch (error) {
        console.error('Error al guardar m√©todo de notificaciones:', error);
        alert('‚ùå Error al guardar configuraci√≥n');
    }
}

async function testNotification() {
    const hasPermission = await requestNotificationPermission();

    if (hasPermission) {
        new Notification('üéâ ¬°Notificaci√≥n de Prueba!', {
            body: 'Las notificaciones est√°n funcionando correctamente. ¬°Ya est√°s listo!',
            icon: 'icon-192.png',
            badge: 'icon-192.png',
            vibrate: [200, 100, 200, 100, 200],
            requireInteraction: false,
            tag: 'test-notification'
        });

        // Tambi√©n mostrar notificaci√≥n persistente si el service worker est√° disponible
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.ready.then(registration => {
                registration.showNotification('üîî Notificaci√≥n Persistente', {
                    body: 'Esta notificaci√≥n funciona incluso cuando cierras la app.',
                    icon: 'icon-192.png',
                    badge: 'icon-192.png',
                    vibrate: [200, 100, 200],
                    requireInteraction: true,
                    actions: [
                        { action: 'close', title: 'Cerrar' }
                    ]
                });
            });
        }

        alert('‚úÖ Notificaci√≥n enviada!\n\nDeber√≠as verla aparecer ahora.');
    } else {
        alert('‚ùå No se pudo enviar la notificaci√≥n.\n\nAseg√∫rate de permitir las notificaciones en tu navegador.');
    }
}

// ==============================================
// SISTEMA MEJORADO DE NOTIFICACIONES (ALARMAS)
// ==============================================

/**
 * Programa una notificaci√≥n mejorada tipo alarma para un recordatorio
 */
async function scheduleEnhancedNotification(reminder) {
    if (!reminder.date || !reminder.time) {
        console.log('‚ö†Ô∏è Recordatorio sin fecha/hora, no se programa notificaci√≥n');
        return;
    }

    // Solo notificaciones web ‚Äî Google Calendar se maneja en saveReminder
    scheduleWebNotification(reminder);
}

/**
 * Programa una notificaci√≥n web mejorada
 */
function scheduleWebNotification(reminder) {
    const reminderDate = parseLocalDate(reminder.date);
    const [hours, minutes] = reminder.time.split(':').map(Number);
    reminderDate.setHours(hours, minutes, 0, 0);

    const now = new Date();
    const timeUntilReminder = reminderDate - now;

    // Cancelar timeouts previos de este recordatorio para evitar duplicados
    if (scheduledNotificationTimeouts.has(reminder.id)) {
        clearTimeout(scheduledNotificationTimeouts.get(reminder.id));
        scheduledNotificationTimeouts.delete(reminder.id);
    }
    const beforeKey = `${reminder.id}_before`;
    if (scheduledNotificationTimeouts.has(beforeKey)) {
        clearTimeout(scheduledNotificationTimeouts.get(beforeKey));
        scheduledNotificationTimeouts.delete(beforeKey);
    }

    if (timeUntilReminder > 0) {
        // Programar notificaci√≥n exacta
        const timeoutId = setTimeout(() => {
            showAlarmNotification(reminder);
            scheduledNotificationTimeouts.delete(reminder.id);
        }, timeUntilReminder);
        scheduledNotificationTimeouts.set(reminder.id, timeoutId);

        // Tambi√©n programar recordatorio 15 minutos antes
        const reminderBefore = timeUntilReminder - (15 * 60 * 1000);
        if (reminderBefore > 0) {
            const beforeId = setTimeout(() => {
                showAlarmNotification(reminder, true);
                scheduledNotificationTimeouts.delete(beforeKey);
            }, reminderBefore);
            scheduledNotificationTimeouts.set(beforeKey, beforeId);
        }

        console.log(`‚è∞ Notificaci√≥n programada para ${reminder.date} ${reminder.time}`);
    } else {
        console.log('‚ö†Ô∏è La fecha del recordatorio ya pas√≥');
    }
}

/**
 * Muestra una notificaci√≥n tipo alarma (persistente y con sonido)
 */
async function showAlarmNotification(reminder, isBefore = false) {
    const hasPermission = await requestNotificationPermission();
    if (!hasPermission) return;

    const title = isBefore
        ? `‚è∞ Recordatorio en 15 minutos`
        : `üîî ${reminder.title}`;

    const body = isBefore
        ? `Pr√≥ximamente: ${reminder.title}\n${reminder.subject || ''}`
        : `${reminder.subject || ''}\n${reminder.description || ''}`.trim();

    const options = {
        body: body,
        icon: 'icon-512.png',
        badge: 'icon-192.png',
        vibrate: [300, 100, 300, 100, 300, 100, 300], // Vibraci√≥n m√°s larga
        requireInteraction: true, // No se cierra autom√°ticamente
        tag: `reminder-${reminder.id}`,
        renotify: true,
        actions: [
            { action: 'complete', title: '‚úÖ Completar' },
            { action: 'snooze', title: '‚è∞ Posponer 10 min' },
            { action: 'close', title: '‚úñÔ∏è Cerrar' }
        ],
        data: {
            reminderId: reminder.id,
            url: '/',
            timestamp: Date.now()
        }
    };

    // Intentar usar Service Worker para notificaci√≥n persistente
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        try {
            const registration = await navigator.serviceWorker.ready;
            await registration.showNotification(title, options);
            console.log('üîî Notificaci√≥n de alarma mostrada (Service Worker)');
        } catch (error) {
            console.error('Error al mostrar notificaci√≥n SW:', error);
            // Fallback a notificaci√≥n normal
            new Notification(title, options);
        }
    } else {
        // Notificaci√≥n normal
        new Notification(title, options);
    }
}

// ==============================================
// INTEGRACI√ìN CON GOOGLE CALENDAR
// ==============================================
// gapiInited, gisInited, tokenClient, gapiLoaded(), gisLoaded(), initGoogleCalendar()
// est√°n definidos en <head> para evitar problemas de timing con scripts async.

/**
 * Agrega un recordatorio a Google Calendar.
 * Retorna el ID del evento creado, o null si falla.
 */
async function addToGoogleCalendar(reminder) {
    return new Promise(async (resolve) => {
        if (!gapiInited || !gisInited) {
            console.log('‚ö†Ô∏è Google Calendar no inicializado. Inicializando...');
            initGoogleCalendar();
            await new Promise(r => setTimeout(r, 1500));
        }

        tokenClient.callback = async (response) => {
            if (response.error !== undefined) {
                console.error('Error de autorizaci√≥n Calendar:', response);
                resolve(null);
                return;
            }

            try {
                const reminderDate = parseLocalDate(reminder.date);
                const [hours, minutes] = (reminder.time || '09:00').split(':').map(Number);

                const startDateTime = new Date(reminderDate);
                startDateTime.setHours(hours, minutes, 0, 0);

                const endDateTime = new Date(startDateTime);
                endDateTime.setHours(hours + 1, minutes, 0, 0);

                const categoryEmoji = {
                    tarea: 'üìù', examen: 'üìÑ', exposicion: 'üé§',
                    evento: 'üéâ', congreso: 'üéì', otro: 'üìå'
                }[reminder.type] || 'üìå';

                const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                const event = {
                    summary: `${categoryEmoji} ${reminder.title}`,
                    description: [
                        reminder.subject && `Materia: ${reminder.subject}`,
                        reminder.description
                    ].filter(Boolean).join('\n\n') + '\n\n‚Äî HorarioMat',
                    start: { dateTime: startDateTime.toISOString(), timeZone },
                    end: { dateTime: endDateTime.toISOString(), timeZone },
                    reminders: {
                        useDefault: false,
                        overrides: [
                            { method: 'popup', minutes: 15 },
                            { method: 'popup', minutes: 0 }
                        ]
                    },
                    colorId: '9'
                };

                const calResponse = await gapi.client.calendar.events.insert({
                    calendarId: 'primary',
                    resource: event
                });

                const eventId = calResponse.result.id;
                console.log('‚úÖ Evento creado en Google Calendar:', eventId);
                resolve(eventId);

            } catch (error) {
                console.error('Error al crear evento en Calendar:', error);
                resolve(null);
            }
        };

        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
            tokenClient.requestAccessToken({ prompt: '' });
        }
    });
}

/**
 * Elimina un evento de Google Calendar por su ID.
 */
async function deleteFromGoogleCalendar(eventId) {
    if (!eventId) return false;

    return new Promise(async (resolve) => {
        if (!gapiInited || !gisInited) {
            resolve(false);
            return;
        }

        const doDelete = async () => {
            try {
                await gapi.client.calendar.events.delete({
                    calendarId: 'primary',
                    eventId: eventId
                });
                console.log('‚úÖ Evento eliminado de Google Calendar');
                resolve(true);
            } catch (error) {
                // Si el evento ya no existe (404), no es un error real
                if (error.status === 404 || error.status === 410) {
                    resolve(true);
                } else {
                    console.error('Error al eliminar evento de Calendar:', error);
                    resolve(false);
                }
            }
        };

        if (gapi.client.getToken() === null) {
            tokenClient.callback = async (response) => {
                if (response.error) { resolve(false); return; }
                await doDelete();
            };
            tokenClient.requestAccessToken({ prompt: '' });
        } else {
            await doDelete();
        }
    });
}

/**
 * Marca un evento de Google Calendar como completado (‚úÖ en t√≠tulo, color gris)
 * o lo restaura a su estado original si se desmarca.
 */
async function markGoogleCalendarEventCompleted(eventId, reminder, completed) {
    if (!eventId) return false;

    return new Promise(async (resolve) => {
        if (!gapiInited || !gisInited) {
            resolve(false);
            return;
        }

        const doUpdate = async () => {
            try {
                let patchData;
                if (completed) {
                    // Marcar como completado: t√≠tulo con ‚úÖ y color gris (graphite)
                    patchData = {
                        summary: `‚úÖ ${reminder.title}`,
                        colorId: '8' // graphite/gris
                    };
                    console.log('‚úÖ Evento marcado como completado en Google Calendar');
                } else {
                    // Restaurar: t√≠tulo original con emoji de categor√≠a y color original
                    const categoryEmoji = {
                        tarea: 'üìù', examen: 'üìÑ', exposicion: 'üé§',
                        evento: 'üéâ', congreso: 'üéì', otro: 'üìå'
                    }[reminder.type] || 'üìå';
                    patchData = {
                        summary: `${categoryEmoji} ${reminder.title}`,
                        colorId: '9'
                    };
                    console.log('‚Ü©Ô∏è Evento restaurado como pendiente en Google Calendar');
                }

                await gapi.client.calendar.events.patch({
                    calendarId: 'primary',
                    eventId: eventId,
                    resource: patchData
                });
                resolve(true);
            } catch (error) {
                if (error.status === 404 || error.status === 410) {
                    resolve(true); // El evento ya no existe, no es un error real
                } else {
                    console.error('Error al actualizar estado del evento en Calendar:', error);
                    resolve(false);
                }
            }
        };

        if (gapi.client.getToken() === null) {
            tokenClient.callback = async (response) => {
                if (response.error) { resolve(false); return; }
                await doUpdate();
            };
            tokenClient.requestAccessToken({ prompt: '' });
        } else {
            await doUpdate();
        }
    });
}

// Iniciar cuando carga la p√°gina
// El auth.onAuthStateChanged se encargar√° de mostrar login o app

// Inicializar Google Calendar API cuando cargue
if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
    setTimeout(() => {
        try {
            initGoogleCalendar();
        } catch (error) {
            console.log('‚ö†Ô∏è Google Calendar API no disponible:', error);
        }
    }, 2000);
}
</script>

<!-- Animation for loading spinner -->
<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

</div> <!-- Cierre de main-app -->
</body>
</html>